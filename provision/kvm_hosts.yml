---
- name: Configure kvm hosts

  hosts: kvm_hosts

  become: yes

  vars:

    kvm_provisioning_group: kvm_guests
    iptables_savefile: /etc/iptables/iptables.rules
    kvm_requirement_packages:
      - qemu
      - qemu-kvm
      - libvirt0
      - libvirt-dev
      - libvirt-bin
      - python-lxml
      - bridge-utils
      - ebtables
      - dmidecode

  roles:

    - nephelaiio.plugins
    - nephelaiio.pip

  tasks:

    - name: include variable definitions
      include_vars:
        dir: "../{{ variables }}"

    - name: include os variable overrides
      include_vars: "{{ item }}"
      with_first_found:
        - files:
            - "vars/{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"
            - "vars/{{ ansible_distrubition | lower }}.yml"
            - "vars/{{ ansible_os_family | lower }}.yml"
          skip: true

    - name: install bridging package
      package:
        name: bridge-utils

    - name: configure bridging
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_set: yes
        reload: yes
      with_items:
        - name: net.ipv4.ip_forward
          value: 1

    - name: install package requirements
      package:
        name: "{{ kvm_requirement_packages }}"
        update_cache: yes

    - name: start libvirt daemon
      service:
        name: libvirtd
        state: started
        enabled: yes
