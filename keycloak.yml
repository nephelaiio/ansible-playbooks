---
- name: deploy keycloak to rke

  hosts: keycloak

  gather_facts: no

  vars:

    keycloak_manifest_dir: "{{ rke_manifest_dir }}/keycloak"

  pre_tasks:

    - name: get play username
      command: whoami
      register: rke_install_user_query
      changed_when: false
      tags:
        - always

    - name: set install username
      set_fact:
        rke_install_user: "{{ rke_install_user_query.stdout }}"
      tags:
        - always

  tasks:

    - block:

        - name: add helm repo
          community.kubernetes.helm_repository:
            state: "{{ keycloak_state | default('present') }}"
            name: codecentric
            repo_url: https://codecentric.github.io/helm-charts

        - name: deploy keycloak helm chart
          community.kubernetes.helm:
            state: "{{ keycloak_state | default('present') }}"
            name: "{{ keycloak_deployment }}"
            chart_ref: codecentric/keycloak
            release_values: "{{ lookup('template', 'keycloak/values.j2.yml') | from_yaml }}"
            release_namespace: "{{ keycloak_namespace }}"
            create_namespace: true

        - name: create manifest dir
          file:
            path: "{{ keycloak_manifest_dir }}"
            state: directory

        - name: build keycloak manifest template
          template:
            src: keycloak/manifest.j2.yml
            dest: "{{ keycloak_manifest_dir }}/manifest.yml"
            owner: "{{ rke_install_user }}"
            mode: 0640

        - name: apply keycloak manifest
          k8s:
            state: "{{ keycloak_state | default('present') }}"
            src: "{{ keycloak_manifest_dir }}/manifest.yml"
          loop_control:
            label: "{{ item.dest }}"

      run_once: yes
