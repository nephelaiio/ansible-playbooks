---
- name: Configure foreman partition tables

  hosts: foreman_app

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: query foreman partition tables
      uri:
        url: "{{ foreman_url }}/api/ptables"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_ptable_query

    - name: set ptable facts
      set_fact:
        foreman_ptable_results: "{{ foreman_ptable_query.json.results }}"
        foreman_ptable_names: "{{ foreman_ptable_query.json.results | map(attribute='name') | list }}"

    - name: create foreman ptables
      uri:
        url: "{{ foreman_url }}/api/ptables"
        method: POST
        body_format: json
        body:
          ptable: "{{ ptable }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 201
      vars:
        ptable: "{{ item }}"
      loop_control:
        label: "{{ item.name }}"
      loop: "{{ foreman_ptables.values() | flatten(levels=1) }}"
      when: item.name not in foreman_ptable_names

    - name: update foreman ptables
      uri:
        url: "{{ foreman_url }}/api/ptables/{{ item.id }}"
        method: PUT
        body_format: json
        body:
          ptable: "{{ ptable }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      vars:
        inventory_ptable: "{{ foreman_ptables.values() | list | selectattr('name', 'equalto', item.name) | first }}"
        ptable: "{{ item | combine(inventory_ptable) }}"
      loop_control:
        label: "{{ item.name }}"
      loop: "{{ foreman_ptable_results | flatten(levels=1) }}"
      when: item.name in (foreman_ptables.values() | map(attribute='name'))
