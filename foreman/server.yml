- name: Install foreman server

  hosts: foreman_server

  become: yes

  vars:

    foreman_dhcp_nameservers: "{{ groups['pdns_recursors'] | map('extract', hostvars, ['ansible_host']) | list }}"
    foreman_dhcp_interface: "{{ ansible_default_ipv4 }}"
    foreman_dhcp_subnet: "{{ foreman_dhcp_interface.network }}/{{ foreman_dhcp_interface.netmask }}"
    foreman_dhcp_from: 64
    foreman_dhcp_to: 96
    foreman_installer_extra_options:
      - "--puppet-autosign true"
      - "--puppet-autosign-entries '*.{{ base_domain }}'"
      - "--foreman-oauth-active true"
      - "--foreman-oauth-consumer-key {{ foreman_oauth_consumer_key }}"
      - "--foreman-oauth-consumer-secret {{ foreman_oauth_consumer_secret }}"
      - "--foreman-server-ssl-cert {{ acme_certificate_certfile }}"
      - "--foreman-server-ssl-chain {{ acme_certificate_chainfile }}"
      - "--foreman-server-ssl-key {{ acme_certificate_keyfile }}"
      - "--enable-foreman-proxy"
      - "--foreman-proxy-foreman-base-url {{ foreman_url }}"
      - "--foreman-proxy-puppet true"
      - "--enable-foreman-proxy-plugin-discovery"
      - "--enable-foreman-proxy-plugin-dns-powerdns"
      - "--foreman-proxy-ssl-ca /etc/puppetlabs/puppet/ssl/certs/ca.pem"
      - "--foreman-proxy-ssl-cert /etc/puppetlabs/puppet/ssl/certs/{{ inventory_hostname }}.pem"
      - "--foreman-proxy-ssl-key /etc/puppetlabs/puppet/ssl/private_keys/{{ inventory_hostname }}.pem"
      - "--foreman-proxy-oauth-consumer-key {{ foreman_oauth_consumer_key }}"
      - "--foreman-proxy-oauth-consumer-key {{ foreman_oauth_consumer_key }}"
      - "--foreman-proxy-oauth-consumer-secret {{ foreman_oauth_consumer_secret }}"
      - "--foreman-proxy-bmc true"
      - "--foreman-proxy-dhcp true"
      - "--foreman-proxy-dhcp-interface {{ foreman_dhcp_interface.interface }}"
      - "--foreman-proxy-dhcp-network {{ foreman_dhcp_subnet | ipaddr('network') }}"
      - "--foreman-proxy-dhcp-netmask {{ foreman_dhcp_subnet | ipaddr('netmask') }}"
      - "--foreman-proxy-dhcp-gateway {{ foreman_dhcp_subnet | ipaddr(1) | ipaddr('address') }}"
      - "--foreman-proxy-dhcp-nameservers {{ foreman_dhcp_nameservers | join(',') }}"
      - "--foreman-proxy-dhcp-range '{{ foreman_dhcp_subnet | ipaddr(foreman_dhcp_from) | ipaddr('address') }} {{  foreman_dhcp_subnet | ipaddr(foreman_dhcp_to) | ipaddr('address') }}'"
      - "--foreman-proxy-dns true"
      - "--foreman-proxy-dns-provider powerdns"
      - "--foreman-proxy-plugin-dns-powerdns-backend rest"
      - "--foreman-proxy-plugin-dns-powerdns-rest-api-key {{ foreman_pdns_api_key }}"
      - "--foreman-proxy-plugin-dns-powerdns-rest-url {{ foreman_pdns_url }}/api/v1/servers/localhost"
      - "--foreman-proxy-plugin-discovery-install-images true"
      - "--foreman-proxy-http true"
      - "--foreman-proxy-logs true"
      - "--foreman-proxy-puppet true"
      - "--foreman-proxy-tftp true"

  pre_tasks:

    - name: install apache
      package:
        name: httpd

    - name: update foreman pdns record
      uri:
        url: "{{ pdns_url }}/api/v1/servers/localhost/zones/{{ foreman_fqdn_zone }}"
        method: PATCH
        return_content: yes
        body_format: json
        body:
          rrsets:
            - name: "{{ foreman_fqdn_host }}"
              type: A
              ttl: 3600
              changetype: REPLACE
              records:
                - content: "{{ ansible_host | default(ansible_default_ipv4.address) }}"
                  disabled: no
                  comments: []
        headers:
          X-API-Key: "{{ pdns_api_key }}"
        status_code: 204
      vars:
        foreman_host: "{{ foreman_url | urlsplit('hostname') }}"
        foreman_fqdn_host: "{{ foreman_host | regex_replace('\\.$', '') }}."
        foreman_fqdn_zone: "{{ foreman_host.split('.')[1:] | join('.') }}"

  roles:

    - nephelaiio.acme_certificate_route53
    - nephelaiio.foreman.repo
    - nephelaiio.foreman.server
