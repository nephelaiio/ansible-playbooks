---
- name: Configure foreman hosts

  hosts: foreman_guests

  become: yes

  gather_facts: no

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - block:

        - name: query foreman hosts
          uri:
            url: "{{ foreman_url }}/api/hosts"
            method: GET
            body_format: json
            body:
              per_page: "{{ foreman_api_allpages }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 200
          register: foreman_host_query

        - name: query foreman subnets
          uri:
            url: "{{ foreman_url }}/api/subnets"
            method: GET
            body_format: json
            body:
              per_page: "{{ foreman_api_allpages }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 200
          register: foreman_subnet_query

        - name: query foreman domains
          uri:
            url: "{{ foreman_url }}/api/domains"
            method: GET
            body_format: json
            body:
              per_page: "{{ foreman_api_allpages }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 200
          register: foreman_domain_query

        - name: set subnet facts
          set_fact:
            foreman_subnets: "{{ foreman_subnet_query.json.results }}"
            foreman_domains: "{{ foreman_domain_query.json.results }}"
            guest_domain: "{{ inventory_hostname | split_with('.') | tail | join('.') }}"

        - debug:
            var: foreman_domain_id

      delegate_to: "{{ groups['foreman'] | first }}"
