---
- name: Install tftpd

  hosts: foreman_proxy

  become: yes

  roles:

    - nephelaiio.plugins

  vars:


  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: include variable overrides
      include_vars: "{{ item }}"
      with_first_found:
        - files:
            - "vars/{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
            - "vars/{{ ansible_distribution }}.yml"
            - "vars/{{ ansible_os_family }}.yml"
            - "vars/default.yml"
      run_once: yes

    - name: install tftp packages
      package:
        name: "{{ foreman_tftp_packages }}"
        state: latest

    - name: create tftp root
      file:
        dest: "{{ foreman_tftp_root }}"
        state: directory
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
        mode: 0770

    - name: create tftp symlinks
      file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
        state: link
      loop:
        - src: /usr/lib/PXELINUX/pxelinux.0
          dest: "{{ foreman_tftp_root }}/pxelinux.0"
        - src: /usr/lib/syslinux/modules/bios/menu.c32
          dest: "{{ foreman_tftp_root }}/menu.c32"
        - src: /usr/lib/syslinux/modules/bios/chain.c32
          dest: "{{ foreman_tftp_root }}/chain.c32"
        - src: /usr/lib/syslinux/modules/bios/ldlinux.c32
          dest: "{{ foreman_tftp_root }}/ldlinux.c32"
        - src: /usr/lib/syslinux/modules/bios/libcom32.c32
          dest: "{{ foreman_tftp_root }}/libcom32.c32"
        - src: /usr/lib/syslinux/modules/bios/libutil.c32
          dest: "{{ foreman_tftp_root }}/libutil.c32"
      when: ansible_os_family == 'Debian'

    - name: configure tftp xinetd daemon
      copy:
        dest: /etc/xinetd.d/tftp
        content: |
          service tftp
          {
          protocol        = udp
          port            = 69
          socket_type     = dgram
          wait            = yes
          user            = {{ foreman_proxy_user }}
          server          = /usr/sbin/in.tftpd
          server_args     = {{ foreman_tftp_root }}
          disable         = no
          }
        mode: 0640
      notify: restart tftpd

    - name: start tftpd
      service:
        name: xinetd
        state: started
        enabled: yes

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/tftp.yml
        content: |
          ---
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :enabled: true
          :tftproot: "{{ foreman_tftp_root }}"
          :tftp_servername: "{{ ansible_default_ipv4.address }}"
      notify:
        - restart foreman proxy

    - meta: flush_handlers

    - include_tasks: proxy/register.yml

  handlers:

    - name: restart tftpd
      service:
        name: xinetd
        state: restarted

    - name: restart foreman proxy
      service:
        name: foreman-proxy
        state: restarted
