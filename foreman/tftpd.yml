---
- name: Install tftpd

  hosts: foreman_proxy

  become: yes

  roles:

    - nephelaiio.plugins

  vars:


  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: install tftp packages
      package:
        name:
          - xinetd
          - tftpd
          - tftp
        state: latest

    - name: create tftp root
      file:
        dest: "{{ foreman_tftp_root }}"
        state: directory
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
        mode: 0770

    - name: configure tftp xinetd daemon
      copy:
        dest: /etc/xinetd.d/tftp
        content: |
          {
          protocol        = udp
          port            = 69
          socket_type     = dgram
          wait            = yes
          user            = "{{ foreman_proxy_user }}"
          group           = "{{ foreman_proxy_group }}"
          server          = /usr/sbin/in.tftpd
          server_args     = "{{ foreman_tftp_root }}"
          disable         = no
          }
        mode: 0640
      notify: restart tftpd

    - name: start tftpd
      service:
        name: xinetd
        state: started
        enabled: yes

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/tftp.yml
        content: |
          ---
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :enabled: true
          :tftproot: "{{ foreman_tftp_root }}"
          :tftp_servername: "{{ ansible_fqdn }}"
      notify:
        - restart foreman proxy

    - meta: flush_handlers

    - include_tasks: proxy/register.yml

  handlers:

    - name: restart tftpd
      service:
        name: xinetd
        state: restarted

    - name: restart foreman proxy
      service:
        name: foreman-proxy
        state: restarted
