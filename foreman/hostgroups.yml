---
- name: Configure foreman hostgroups

  hosts: foreman_app

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: query foreman architectures
      uri:
        url: "{{ foreman_url }}/api/architectures"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_arch_query

    - name: set architecture facts
      set_fact:
        foreman_arch_results: "{{ foreman_arch_query.json.results }}"

    - name: query foreman operating systems
      uri:
        url: "{{ foreman_url }}/api/operatingsystems"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_os_query

    - name: set operating system facts
      set_fact:
        foreman_os_results: "{{ foreman_os_query.json.results }}"

    - name: query foreman domains
      uri:
        url: "{{ foreman_url }}/api/domains"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_domain_query

    - name: set domain facts
      set_fact:
        foreman_domain_results: "{{ foreman_domain_query.json.results }}"

    - name: query foreman subnets
      uri:
        url: "{{ foreman_url }}/api/subnets"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_subnet_query

    - name: set subnet facts
      set_fact:
        foreman_subnet_results: "{{ foreman_subnet_query.json.results }}"

    - name: query foreman media
      uri:
        url: "{{ foreman_url }}/api/media"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_media_query

    - name: set media facts
      set_fact:
        foreman_media_results: "{{ foreman_media_query.json.results }}"

    - name: query foreman partition tables
      uri:
        url: "{{ foreman_url }}/api/ptables"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_ptable_query

    - name: set template facts
      set_fact:
        foreman_ptable_results: "{{ foreman_ptable_query.json.results }}"

    - name: query foreman hostgroups
      uri:
        url: "{{ foreman_url }}/api/hostgroups"
        method: GET
        body_format: json
        body:
          per_page: "{{ foreman_api_allpages }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_hostgroup_query

    - name: set hostgroup facts
      set_fact:
        foreman_hostgroup_results: "{{ foreman_hostgroup_query.json.results | list }}"
        foreman_hostgroup_names: "{{ foreman_hostgroup_query.json.results | map(attribute='name') | list }}"

    - name: create foreman hostgroup
      uri:
        url: "{{ foreman_url }}/api/hostgroups"
        method: POST
        body_format: json
        body:
          hostgroup:
            name: "{{ item.name }}"
            description: "{{ item.description | default(omit) }}"
            architecture_id: "{{ foreman_arch_results | selectattr('name', 'equalto', inventory_hostgroup.architecture) | map(attribute='id') | first }}"
            operatingsystem_id: "{{ foreman_os_results | selectattr('name', 'equalto', inventory_hostgroup.operatingsystem) | map(attribute='id') | first }}"
            subnet_id: "{{ (foreman_subnet_results | selectattr('name', 'equalto', inventory_hostgroup.subnet | default('')) | map(attribute='id') | first) | default(omit) }}"
            domain_id: "{{ (foreman_domain_results | selectattr('name', 'equalto', inventory_hostgroup.domain | default('')) | map(attribute='id') | first) | default(omit) }}"
            medium_id: "{{ (foreman_media_results | selectattr('name', 'equalto', inventory_hostgroup.medium | default('')) | map(attribute='id') | first) | default(omit) }}"
            ptable_id: "{{ (foreman_ptable_results | selectattr('name', 'equalto', inventory_hostgroup.ptable | default('')) | map(attribute='id') | first) | default(omit) }}"
            pxe_loader: "{{ inventory_hostgroup.pxe_loader | default(omit) }}"
            root_pass: "{{ inventory_hostgroup.root_pass | default(omit) }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 201
      vars:
        inventory_hostgroup: "{{ foreman_hostgroups.values() | list | selectattr('name', 'equalto', item.name) | first }}"
      loop_control:
        label: "{{ item.name }}"
      with_items: "{{ foreman_hostgroups.values() | list }}"
      when: item.name not in foreman_hostgroup_names

    - name: update foreman hostgroups
      uri:
        url: "{{ foreman_url }}/api/hostgroups/{{ item.id }}"
        method: PUT
        body_format: json
        body:
          hostgroup: "{{ foreman_hostgroup }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      vars:
        inventory_hostgroup: "{{ foreman_hostgroups.values() | list | selectattr('name', 'equalto', item.name) | first }}"
        foreman_hostgroup:
          name: "{{ inventory_hostgroup.name }}"
          description: "{{ inventory_hostgroup.description | default(omit) }}"
          architecture_id: "{{ foreman_arch_results | selectattr('name', 'equalto', inventory_hostgroup.architecture) | map(attribute='id') | first }}"
          operatingsystem_id: "{{ foreman_os_results | selectattr('name', 'equalto', inventory_hostgroup.operatingsystem) | map(attribute='id') | first }}"
          subnet_id: "{{ (foreman_subnet_results | selectattr('name', 'equalto', inventory_hostgroup.subnet | default('')) | map(attribute='id') | first) | default(omit) }}"
          domain_id: "{{ (foreman_domain_results | selectattr('name', 'equalto', inventory_hostgroup.domain | default('')) | map(attribute='id') | first) | default(omit) }}"
          medium_id: "{{ (foreman_media_results | selectattr('name', 'equalto', inventory_hostgroup.medium | default('')) | map(attribute='id') | first) | default(omit) }}"
          ptable_id: "{{ (foreman_ptable_results | selectattr('name', 'equalto', inventory_hostgroup.ptable | default('')) | map(attribute='id') | first) | default(omit) }}"
          pxe_loader: "{{ inventory_hostgroup.pxe_loader | default(omit) }}"
          root_pass: "{{ inventory_hostgroup.root_pass | default(omit) }}"
      loop_control:
        label: "{{ item.name }}"
      with_items: "{{ foreman_hostgroup_results }}"
