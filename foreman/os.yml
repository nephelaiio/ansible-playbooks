---
- name: Configure foreman operating systems

  hosts: foreman

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: query foreman architectures
      uri:
        url: "{{ foreman_url }}/api/architectures"
        method: GET
        body_format: json
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_arch_query

    - name: set architecture facts
      set_fact:
        foreman_arch_results: "{{ foreman_arch_query.json.results }}"

    - name: query foreman media
      uri:
        url: "{{ foreman_url }}/api/media"
        method: GET
        body_format: json
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_media_query

    - name: set media facts
      set_fact:
        foreman_media_results: "{{ foreman_media_query.json.results }}"

    - name: query foreman templates
      uri:
        url: "{{ foreman_url }}/api/config_templates"
        method: GET
        body_format: json
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_template_query

    - name: set template facts
      set_fact:
        foreman_template_results: "{{ foreman_template_query.json.results }}"

    - name: query foreman partition templates
      uri:
        url: "{{ foreman_url }}/api/ptables"
        method: GET
        body_format: json
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_ptable_query

    - name: set partition table facts
      set_fact:
        foreman_ptable_results: "{{ foreman_ptable_query.json.results }}"

    - name: query foreman operating system templates
      uri:
        url: "{{ foreman_url }}/api/operatingsystems"
        method: GET
        body_format: json
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_os_query

    - name: set partition table facts
      set_fact:
        foreman_os_results: "{{ foreman_os_query.json.results }}"
        foreman_os_names: "{{ foreman_os_query.json.results | map(attribute='name') | list }}"

    - name: create foreman os
      uri:
        url: "{{ foreman_url }}/api/operatingsystems"
        method: POST
        body_format: json
        body:
          operatingsystem:
            name: "{{ item.major }}"
            major: "{{ item.major | default(omit) }}"
            minor: "{{ item.minor | default(omit) }}"
            description: "{{ item.description | default(omit) }}"
            family: "{{ item.family | default(omit) }}"
            release_name: "{{ item.release_name | default(omit) }}"
            password_hash: "{{ item.password_hash | default(omit) }}"
            architecture_ids: "{{ foreman_arch_results | selectattr('name', 'equals', item.architecture | default('')) | map(attribute='id') }}"
            template_ids: "{{ foreman_template_results | selectattr('name', 'equals', item.template | default('')) | map(attribute='id') }}"
            medium_ids: "{{ foreman_medium_results | selectattr('name', 'equals', item.medium | default('')) | map(attribute='id') }}"
            ptable_ids: "{{ foreman_ptable_results | selectattr('name', 'equals', item.ptable | default('')) | map(attribute='id') }}"
            os_family: "{{ item.os_family | default(omit) }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 201
      with_items: "{{ foreman_os.values() }}"
      when: item.name not in foreman_os_names

    - name: update foreman os
      uri:
        url: "{{ foreman_url }}/api/operatingsystems/{{ item.id }}"
        method: PUT
        body_format: json
        body:
          operatingsystem:
            name: "{{ inventory_os.name }}"
            major: "{{ inventory_os.major | default(omit) }}"
            minor: "{{ inventory_os.minor | default(omit) }}"
            description: "{{ inventory_os.description | default(omit) }}"
            family: "{{ inventory_os.family | default(omit) }}"
            release_name: "{{ inventory_os.release_name | default(omit) }}"
            password_hash: "{{ inventory_os.password_hash | default(omit) }}"
            architecture_ids: "{{ foreman_arch_results | selectattr('name', 'equals', inventory_os.architecture | default('')) | map(attribute='id') }}"
            template_ids: "{{ foreman_template_results | selectattr('name', 'equals', inventory_os.template | default('')) | map(attribute='id') }}"
            medium_ids: "{{ foreman_medium_results | selectattr('name', 'equals', inventory_os.medium | default('')) | map(attribute='id') }}"
            ptable_ids: "{{ foreman_ptable_results | selectattr('name', 'equals', inventory_os.ptable | default('')) | map(attribute='id') }}"
            os_family: "{{ inventory_os.os_family | default(omit) }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      vars:
        inventory_os: "{{ foreman_os.values() | selectattr('name', 'equalto', item.name) | first }}"
      with_items: "{{ foreman_os_results }}"
      when: item.name in foreman_os_names
