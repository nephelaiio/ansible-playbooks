---
- import_playbook: ../dhcp/install.yml
  vars:
    dhcp_hosts: foreman_proxy


- name: Configure dhcp proxy

  hosts: foreman_proxy

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/dhcp.yml
        content: |
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :enabled: true
      notify:
        - restart foreman proxy

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/dhcp_isc.yml
        content: |
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :config: /etc/dhcp/dhcpd.conf
          :leases: /var/lib/dhcp/dhcpd.leases
          :key_name: "{{ tsigkeys.omapi.name }}"
          :key_secret: "{{ tsigkeys.omapi.secret }}"
          :omapi_port: 7911
      notify:
        - restart foreman proxy

    - meta: flush_handlers

    - include_tasks: proxy/register.yml

  handlers:

    - name: restart foreman proxy
      service:
        name: foreman-proxy
        state: restarted
