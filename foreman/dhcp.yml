---
- import_playbook: ../dhcp/install.yml
  vars:
    dhcp_hosts: foreman_proxy


- name: Configure dhcp proxy

  hosts: foreman_proxy

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/dhcp.yml
        content: |
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :enabled: true
      notify:
        - restart foreman proxy

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/dhcp_isc.yml
        content: |
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :config: /etc/dhcp/dhcpd.conf
          :leases: /var/lib/dhcp/dhcpd.leases
          :key_name: "{{ tsigkeys.omapi.name }}"
          :key_secret: "{{ tsigkeys.omapi.secret }}"
          :omapi_port: 7911
      notify:
        - restart foreman proxy
        - refresh foreman proxy

    - name: query foreman proxies
      uri:
        url: "{{ foreman_url }}/api/smart_proxies"
        method: GET
        body_format: json
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      register: foreman_proxy_query

    - name: set proxy facts
      set_fact:
        foreman_proxy_urls: "{{ foreman_proxy_query.json.results | map(attribute='url') | list }}"
        foreman_proxy_url: "http://{{ ansible_fqdn }}:{{ foreman_proxy_port }}"

    - meta: flush_handlers

    - block:

        - name: register foreman proxy
          uri:
            url: "{{ foreman_url }}/api/smart_proxies"
            method: POST
            body_format: json
            body:
              smart_proxy:
                name: "{{ ansible_fqdn }}"
                url: "{{ foreman_proxy_url }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 201
          register: foreman_proxy_register

        - name: set proxy facts
          set_fact:
            foreman_proxy_id: "{{ foreman_proxy_register.json.id }}"

      when: foreman_proxy_url not in foreman_proxy_urls

    - block:

        - name: set proxy facts
          set_fact:
            foreman_proxy_id: "{{ foreman_proxy_query.json.results | selectattr('url', 'equalto', foreman_proxy_url) | map(attribute='id') | first }}"

        - name: update foreman proxy
          uri:
            url: "{{ foreman_url }}/api/smart_proxies/{{ foreman_proxy_id }}"
            method: PUT
            body_format: json
            body:
              smart_proxy:
                name: "{{ ansible_fqdn }}"
                url: "{{ foreman_proxy_url }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 200

      when: foreman_proxy_url in foreman_proxy_urls

    - name: refresh foreman proxy
      uri:
        url: "{{ foreman_url }}/api/smart_proxies/{{ foreman_proxy_id }}/refresh"
        method: PUT
        body_format: json
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200

  handlers:

    - name: restart foreman proxy
      service:
        name: foreman-proxy
        state: restarted
