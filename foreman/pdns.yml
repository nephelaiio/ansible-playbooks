---
- name: Configure pdns proxy

  hosts: foreman_proxy

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: install gem dependencies
      package:
        name:
          - libpq-dev
          - ruby-pg
          - libmysqlclient-dev

    - name: install powerdns foreman proxy gems
      gem:
        name: "{{ item }}"
        state: present
        user_install: no
      with_items:
        - smart_proxy_dns_powerdns
      notify: restart foreman proxy

    - name: update powerdns bundler gems
      copy:
        content: "gem 'smart_proxy_dns_powerdns'"
        dest: /usr/share/foreman-proxy/bundler.d/dns_powerdns.rb
      notify: restart foreman proxy

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/dns.yml
        content: |
          ---
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :enabled: true
          :use_provider: dns_powerdns
      notify:
        - restart foreman proxy

    - name: manage foreman proxy configuration
      copy:
        dest: /etc/foreman-proxy/settings.d/dns_powerdns.yml
        content: |
          ---
          {{ settings_yaml | to_nice_yaml(indent=2) }}
        mode: 0640
        owner: "{{ foreman_proxy_user }}"
        group: "{{ foreman_proxy_group }}"
      vars:
        settings_yaml:
          :powerdns_backend: rest
          :powerdns_rest_url: "{{ pdns_url }}/api/v1/servers/localhost"
          :powerdns_rest_api_key: "{{ pdns_api_key }}"
      notify:
        - restart foreman proxy

    - meta: flush_handlers

    - include_tasks: proxy/register.yml

  handlers:

    - name: restart foreman proxy
      service:
        name: foreman-proxy
        state: restarted
