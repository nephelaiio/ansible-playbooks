---
- name: Configure foreman hosts

  hosts: foreman_guests

  gather_facts: no

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - block:

        - name: include private variables
          include_vars:
            dir: "../{{ variables }}"

        - name: query foreman hostgroups
          uri:
            url: "{{ foreman_url }}/api/hostgroups"
            method: GET
            body_format: json
            body:
              per_page: "{{ foreman_api_allpages }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 200
          register: foreman_hostgroup_query

        - name: set hostgroup facts
          set_fact:
            foreman_hostgroup_results: "{{ foreman_hostgroup_query.json.results | list }}"

        - name: query foreman hosts
          uri:
            url: "{{ foreman_url }}/api/hosts"
            method: GET
            body_format: json
            body:
              per_page: "{{ foreman_api_allpages }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 200
          register: foreman_host_query

        - name: set host facts
          set_fact:
            foreman_host_results: "{{ foreman_host_query.json.results | list }}"
            foreman_host_names: "{{ foreman_host_query.json.results | map(attribute='name') | list }}"

        - debug:
            msg: "{{ foreman_hostgroup_results | selectattr('name', 'equalto', foreman_hostgroup) | first }}"

        - name: create foreman host
          uri:
            url: "{{ foreman_url }}/api/hostgroups"
            method: POST
            body_format: json
            body:
              host:
                name: "{{ inventory_hostname }}"
                hostgroup_id: "{{ foreman_host_hostgroup.id }}"
                mac: "{{ hw_address }}"
            user: "{{ foreman_api_user }}"
            password: "{{ foreman_api_pass }}"
            force_basic_auth: yes
            status_code: 201
          vars:
            foreman_host_hostgroup: "{{ foreman_hostgroup_results | selectattr('name', 'equalto', foreman_hostgroup) | first }}"

      delegate_to: localhost

    - name: update foreman host
      uri:
        url: "{{ foreman_url }}/api/hostgroups/{{ foreman_host.id }}"
        method: PUT
        body_format: json
        body:
          host:
            name: "{{ inventory_hostname }}"
            hostgroup_id: "{{ foreman_host_hostgroup.id }}"
            mac: "{{ hw_address }}"
        user: "{{ foreman_api_user }}"
        password: "{{ foreman_api_pass }}"
        force_basic_auth: yes
        status_code: 200
      vars:
        foreman_host_hostgroup: "{{ foreman_hostgroup_results | selectattr('name', 'equalto', foreman_hostgroup) | first }}"
        foreman_host: "{{ foreman_host_results | selectattr('name', 'equalto', inventory_hostname) | first }}"
