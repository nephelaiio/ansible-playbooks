---
- name: Set up unifi openvpn client

  hosts: fw01.home.nephelai.io

  roles:

    - nephelaiio.plugins

  become: yes

  vars:

    openvpn_credential_root: ../credentials

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: copy openvpn ovpn client files
      copy:
        src: "{{ openvpn_credential_root }}/{{ openvpn_unifi_client_user }}.{{ groups['openvpn_aws'] | first }}.ovpn"
        dest: "{{ openvpn_unifi_conf }}"
      notify: configure unifi ovpn

    - name: include ovpn client auth
      lineinfile:
        dest: "{{ openvpn_unifi_conf }}"
        line: "auth-user-pass {{ openvpn_unifi_conf | dirname }}/auth"
        mode: 0600

    - name: configure ovpn client auth
      copy:
        content: |
          {{ openvpn_unifi_client_user }}
          {{ openvpn_unifi_client_pass }}
        dest: "{{ openvpn_unifi_conf | dirname }}/auth"
        mode: 0600

  handlers:

    - name: create temp file
      tempfile:
        suffix: ovpn
      register: ovpn_temp
      listen: configure unifi ovpn

    - name: create ovpn unifi configuration script
      copy:
        dest: "{{ ovpn_temp.path }}"
        content: |
          #!/bin/vbash

          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces openvpn vtun0 config-file {{ openvpn_unifi_conf }}
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall modify sourceroute rule 10 description openvpn
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall modify sourceroute rule 10 action modify
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall modify sourceroute rule 10 modify table 5
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall modify sourceroute rule 10 source address 192.168.2.0/24
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall source-validation disable
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth1 vif 2 firewall in modify sourceroute
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set interfaces ethernet eth1 vif 2 firewall in name LAN_IN
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set protocols static table 5 interface-route 0.0.0.0/0 next-hop-interface vtun0
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set service nat rule 5004 description 'vtun0 masq'
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set service nat rule 5004 destination address 0.0.0.0/0
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set service nat rule 5004 outbound-interface vtun0
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set service nat rule 5004 type masquerade
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit
          /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper save
        mode: 0750
      listen: configure unifi ovpn

    - name: run ovpn unifi configuration script
      command: "{{ ovpn_temp.path }}"
      listen: configure unifi ovpn

    - name: delete temp file
      file:
        dest: "{{ ovpn_temp.path }}"
        state: absent
      listen: configure unifi ovpn
