---
- name: Configure ubuntu package mirrors

  hosts: ubuntu_mirror

  environment: "{{ proxy_env | default({}) }}"

  become: yes

  vars:

    ubuntu_mirror_thread_num: 20
    ubuntu_mirror_thread_speed: 50k
    ubuntu_rsync_bw: 1M
    ubuntu_mirror_root: "{{ mirror_root }}/{{ ubuntu_mirror_dir }}"
    ubuntu_mirror_list: /etc/apt/mirror.ubuntu.list
    ubuntu_vhost_path: "{{ web_root }}/{{ ubuntu_mirror_dir }}"
    ubuntu_update_bin: /usr/local/bin/ubuntu-update
    ubuntu_mirror_distros:
      - xenial
      - bionic

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: update ubuntu pdns record
      uri:
        url: "{{ pdns_url }}/api/v1/servers/localhost/zones/{{ ubuntu_url_zone }}"
        method: PATCH
        return_content: yes
        body_format: json
        body:
          rrsets:
            - name: "{{ ubuntu_url_host }}"
              type: A
              ttl: 3600
              changetype: REPLACE
              records:
                - content: "{{ ansible_default_ipv4.address }}"
                  disabled: no
                  set-ptr: no
                  comments: []
        headers:
          X-API-Key: "{{ pdns_api_key }}"
        status_code: 204
      vars:
        ubuntu_url_host: "{{ ubuntu_url | urlsplit('hostname') }}."
        ubuntu_url_zone: "{{ ubuntu_url_host | split_with('.') | tail | join('.') }}"
      register: pdns_zones_query

    - name: install mirror packages
      package:
        name:
          - rsync
          - util-linux
          - wget

    - name: create mirror directories
      file:
        path: "{{ item }}"
        state: directory
        mode: 0755
      with_items:
        - "{{ mirror_root }}"
        - "{{ web_root }}"
        - "{{ ubuntu_mirror_root }}"

    - name: manage ubuntu mirror configuration
      file:
        dest: "{{ ubuntu_mirror_list }}"
        state: absent

    - name: create ubuntu mirror link
      file:
        path: "{{ ubuntu_vhost_path }}"
        src: "{{ ubuntu_mirror_root }}"
        state: link
        force: yes

    - name: create ubuntu mirror update script
      copy:
        content: |
          #!/usr/bin/env bash

          for distro in {{ ubuntu_mirror_distros | join(' ') }} ; do
            RSYNC_MAIN_SOURCE="rsync://{{ ubuntu_mirror_host }}/ubuntu/dists/$distro*"
            MAIN_ROOT="{{ ubuntu_mirror_root }}/dists"
            mkdir -p $MAIN_ROOT
            flock -n /tmp/ubuntu-mirror rsync -av -P --bwlimit={{ ubuntu_rsync_bw }} --exclude "*-proposed" $RSYNC_MAIN_SOURCE $MAIN_ROOT
          done;

          RSYNC_POOL_SOURCE="rsync://{{ ubuntu_mirror_host }}/ubuntu/pool"
          POOL_ROOT="{{ ubuntu_mirror_root }}/pool"
          mkdir -p $POOL_ROOT
          flock -n /tmp/ubuntu-mirror rsync -av -P --bwlimit={{ ubuntu_rsync_bw }} $RSYNC_POOL_SOURCE $POOL_ROOT

        dest: "{{ ubuntu_update_bin }}"
        owner: root
        group: root
        mode: 0750

    - name: create mirror update motd pointers
      copy:
        dest: /etc/update-motd.d/97-ubuntu-mirror
        content: |
          #!/usr/bin/env bash
          echo
          echo run sudo {{ ubuntu_update_bin }} to update centos mirror manually
        mode: 0755

    - name: delete stale motd pointers
      file:
        dest: "{{ item }}"
        state: absent
      with_items:
        - /etc/update-motd.d/99-ubuntu-mirror

    - name: add ubuntu mirror update cronjob
      cron:
        name: 'update ubuntu mirror cache'
        job: "{{ ubuntu_update_bin }}"
        special_time: daily

    - name: configure nginx
      include_role:
        name: geerlingguy.nginx
      vars:
        nginx_remove_default_vhost: true
        nginx_vhosts:
          - listen: "80"
            root: "{{ web_root }}"
            server_name: "{{ ubuntu_url | urlsplit('hostname') }}"
            access_log: "/var/log/nginx/{{ ubuntu_url | urlsplit('hostname') }}.access.log"
            error_log: "/var/log/nginx/{{ ubuntu_url | urlsplit('hostname') }}.error.log"
            extra_parameters: |
              autoindex on;
