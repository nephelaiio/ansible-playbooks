---
- name: Install traefik server

  hosts: traefik

  become: yes

  roles:

    - nephelaiio.pip
    - nephelaiio.consul
    - nephelaiio.traefik

  pre_tasks:

    - block:

        - name: install boto
          pip:
            name: boto

        - name: retrieve public ip
          uri:
            url: https://ifconfig.co
            return_content: yes
            http_agent: curl/7.58.0
          register: ifconfig_query

        - name: update route53 record
          route53:
            aws_access_key: "{{ aws_access_key_id }}"
            aws_secret_key: "{{ aws_secret_access_key }}"
            zone: "{{ traefik_service_domain }}"
            record: "{{ traefik_service_domain }}"
            type: A
            value: "{{ ifconfig_query.content }}"
            state: present
            overwrite: yes

      run_once: yes
      tags:
        - route53
