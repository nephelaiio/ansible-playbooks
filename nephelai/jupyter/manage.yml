# vim: ts=2 sw=2 et :
---
- include: present.yml

- name: manage jupyter.nephelai.io artifacts

  hosts: local

  vars_files: 
    - vars.yml

  tasks:

    - name: query instance ids
      changed_when: false
      local_action: command aws ec2 describe-instances --region {{ region }} --filter Name=client-token,Values={{ client_token }} --query "Reservations[].Instances[].InstanceId"
      register: instance_query

    - debug:
        var: instance_query

    - name: define instance_id
      set_fact: 
        instance_id: "{{ instance_query.stdout | from_json | list }}"

    - name: manage jupyter instances
      local_action:
        module: ec2
        region: "{{ region }}"
        id: "{{ client_token }}"
        instance_ids: "{{ instance_id }}"
        state: "{{ state }}"
      when: 
        - (instance_query.stdout | from_json | length > 0) and (state in ['stopped', 'running'])
