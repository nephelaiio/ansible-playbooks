---
- name: Upgrade hosts

  hosts: online

  become: yes

  ignore_unreachable: yes

  tasks:

    - block:

        - name: Upgrade Debian
          block:

            - name: upgrade apt
              apt:
                force_apt_get: yes
                upgrade: safe

            - name: remove apt orphans
              command: apt autoremove -y
              changed_when: false

          when: ansible_os_family == 'Debian'

        - name: Upgrade Archlinux
          block:

            - name: upgrade pacman
              pacman:
                update_cache: yes
                upgrade: yes

            - name: find pacman orphans
              changed_when: false
              failed_when: false
              command: pacman -Qtdq
              register: orphans

            - name: remove pacman orphans
              command: pacman -Rns --noconfirm {{ orphans.stdout }}
              when:
                - orphans.stdout != ''

          when: ansible_os_family == 'Archlinux'

        - name: Upgrade RedHat
          block:

            - name: upgrade yum
              yum:
                name: '*'
                state: latest
              tags:
                - skip_ansible_lint

          when: ansible_os_family == 'RedHat'

      when:
        - ! (unreachable | default('no'))
        - ansible_os_family is defined
