- name: create temporary directory
  tempfile:
    state: directory
    prefix: kvm_pool_{{ pool.name}}_
  register: tmpdir
  changed_when: False

- name: set pool definition path 
  set_fact:
    pool_def: "{{ tmpdir.path }}/pool_{{ pool.name }}.xml"

- name: create pool templates
  template:
    src: ../templates/kvm/pool.xml.j2
    dest: "{{ pool_def }}"

- name: create pool
  virt_pool:
    command: define
    mode: overwrite
    name: "{{ pool.name }}"
    xml: "{{ pool_def }}"

- name: remove temporary directory
  local_action: >-
    file
    path="{{ tmpdir.path }}"
    state=absent
  changed_when: False
  when: cleanup
