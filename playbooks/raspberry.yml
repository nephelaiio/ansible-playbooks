---
- name: upgrade firmware

  hosts: raspberry

  become: yes

  vars:

    ntp_timezone: "{{ timezone }}"
    ntp_manage_config: true

  roles:

    - geerlingguy.ntp

  tasks:

    - name: Install rpi-update
      apt:
        name: rpi-update
        state: latest
        update_cache: yes

    - name: Upgrade firmware
      shell: rpi-update
      changed_when: false

    - name: Fix rsyslog
      copy:
        dest: /etc/rsyslog.conf
        src: ../files/raspberry/rsyslog.conf
      notify: restart rsyslog

    - name: Configure remote logging
      include_role:
        name: alekseyp.papertrail
      vars:
        papertrail_destination: "{{ papertrail.destination }}"

    - name: Install fail2ban
      apt:
        name: fail2ban
        state: latest
        update_cache: yes

    - name: Configure fail2ban networks
      lineinfile:
        regexp: '^ignoreip ='
        line: "ignoreip = 127.0.0.1/8, {{ network | ipaddr('net') }}"
        dest: /etc/fail2ban/jail.conf
        insertafter: '[DEFAULT]'
      vars:
        network: "{{ nets.home.network }}/{{ nets.home.netmask }}"
      notify: restart fail2ban

    - name: Manage fail2ban services
      service:
        name: fail2ban
        state: started
        enabled: yes

    - name: Disable ssh password logins
      lineinfile:
        regexp: '^#?PasswordAuthentication'
        line: "PasswordAuthentication no"
        dest: /etc/ssh/sshd_config
      notify: restart ssh

  handlers:
    - name: restart rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: restart rsyslogd
      service:
        name: rsyslog
        state: restarted

    - name: restart cron
      service:
        name: cron
        state: restarted

    - name: restart fail2ban
      service:
        name: fail2ban
        state: restarted

    - name: restart ssh
      service:
        name: ssh
        state: restarted
