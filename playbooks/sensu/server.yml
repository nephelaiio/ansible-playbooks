---
- hosts: "{{ target_hosts }}"

  become: yes

  tasks:

    - name: Install RabbitMQ packages
      apt:
        name: "{{ item }}"
        state: latest
      with_items:
        - rabbitmq-server
      notify: Enable RabbitMQ management

    - name: Retrieve RabbitMQ virtual hosts
      changed_when: false
      command: rabbitmqctl list_vhosts name
      register: rabbitmq_vhosts

    - name: Remove default RabbitMQ virtual host
      command: rabbitmqctl delete_vhost /
      when: "'/' in rabbitmq_vhosts.stdout_lines"

    - name: Create Sensu RabbitMQ virtual host
      command: "rabbitmqctl add_vhost {{ rabbitmq.sensu.vhost }}"
      when: rabbitmq.sensu.vhost not in rabbitmq_vhosts.stdout_lines

    - name: Retrieve RabbitMQ users
      changed_when: false
      command: rabbitmqctl list_users
      register: rabbitmq_users

    - name: Remove RabbitMQ guest user
      command: "rabbitmqctl delete_user guest"
      when: "'guest' in rabbitmq_users.stdout"

    - name: Create RabbitMQ Sensu user
      command: "rabbitmqctl add_user {{ rabbitmq.sensu.user }} {{ rabbitmq.sensu.password }}"
      when: rabbitmq.sensu.user not in rabbitmq_users.stdout
      notify: Assign RabbitMQ sensu permissions

    - name: Install Redis packages
      apt:
        name: "{{ item }}"
        state: latest
      with_items:
        - redis-server
      notify: Enable RabbitMQ management

    - name: Ensure redis binds to accessible IP
      lineinfile:
        dest: /etc/redis/redis.conf
        regexp: '^bind'
        line: 'bind 0.0.0.0'
      notify: Restart Redis service

    - name: Create sensu user
      user:
        name: "{{ sensu.user }}"
        state: present
        home: "{{ sensu.env }}"
        system: yes

    - name: Install rbenv
      include_role:
        name: nephelaiio.rbenv
      vars:
        rbenv_user: sensu
        rbenv_ruby: 2.4.1
        rbenv_gems:
          - sensu
        rbenv_plugins:
          - name: "ruby-build"
            repo: "https://github.com/rbenv/ruby-build.git"
          - name: "rbenv-default-gems"
            repo: "https://github.com/rbenv/rbenv-default-gems.git"
          - name: "rbenv-update"
            repo: "https://github.com/rkh/rbenv-update.git"

    - name: Manage services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - rabbitmq-server
        - redis-server

  handlers:

    - name: Enable RabbitMQ management
      command: rabbitmq-plugins enable rabbitmq_management
      notify: Restart RabbitMQ
      when: rabbitmq.management

    - name: Restart RammitMQ
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - rabbitmq-server

    - name: Assign RabbitMQ sensu permissions
      command: "rabbitmqctl set_permissions -p {{ rabbitmq.sensu.vhost }} {{ rabbitmq.sensu.user }} '.*' '.*' '.*'"

    - name: Restart Redis service
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - redis-server
