---
- name: Configure workstation

  hosts: cerberus

  roles:

    - nephelaiio.tree
    - nephelaiio.vim
    - nephelaiio.devtools
    - nephelaiio.rbenv
    - nephelaiio.pyenv
    - nephelaiio.tmux
    - nephelaiio.vagrant
    - nephelaiio.i3
    - nephelaiio.docker

  tasks:

    - include: ../upgrade.yml

    - include: ../kvm.yml

    - name: Install Archlinux packages
      package:
        name: nfs-utils
      become: yes
      when: ansible_os_family == 'Archlinux'
      notify: restart_nfs

    - name: Configure exports
      lineinfile:
        path: /etc/exports.d/ansible
        insertafter: EOF
        line: "{{ item.export }}"
        state: "{{ item.state }}"
        create: yes
      with_items:
        - export: "/home {{ nets.home.network }}/{{ nets.home.netmask }}(rw,sync,no_root_squash)"
          state: present
      become: yes
      notify: restart_nfs

    - name: Configure services
      service:
        name: nfs-server
        state: started
        enabled: yes
      become: yes

  handlers:

    - name: Restart NFS
      listen: restart_nfs
      service:
        name: nfs-server
        state: restarted
      become: yes


- name: Configure satellite host

  hosts: nuca

  vars:

    vim_packages:
      - vim-nox
      - silversearcher-ag

  roles:

    - nephelaiio.tree
    - nephelaiio.vim
    - nephelaiio.devtools
    - nephelaiio.rbenv
    - nephelaiio.pyenv
    - nephelaiio.tmux
    - nephelaiio.docker

  tasks:

    - name: Manage PPAs
      apt_repository:
        repo: "{{ item.repo }}"
        state: "{{ item.state | default('present') }}"
      with_items:
        - repo: ppa:kelleyk/emacs
      become: yes

    - name: Install required packages
      package:
        name: emacs25-nox
      become: yes

    - name: Install spacemacs
      git:
        repo: https://github.com/syl20bnr/spacemacs
        dest: ~/.emacs.d

    - name: Upgrade system
      include: ../upgrade.yml
