---
- name: Disable ipv6
  become: yes
  sysctl:
    name: "{{ item }}"
    state: present
    value: 1
  with_items:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
    - net.ipv6.conf.lo.disable_ipv6
  register: disable_ipv6

- name: restart unifi
  become: yes
  service:
    name: unifi
    state: restarted
  when: disable_ipv6.changed

- name: Install unifi
  become: yes
  include_role:
    name: nephelaiio.unifi-controller

- name: Create vhost roots
  become: yes
  file:
    state: directory
    path: "{{ item }}"
  with_items: "{{ nginx.vhosts.values() | map(attribute='root') | list }}"

- name: Install nginx
  become: yes
  include_role:
    name: geerlingguy.nginx
  vars:
    nginx_remove_default_vhost: true
    nginx_vhosts:
      - "{{ nginx.vhosts.home_http }}"

- name: Install certbot
  become: yes
  get_url:
    url: "{{ certbot.url }}"
    checksum: "{{ certbot.checksum }}"
    dest: "{{ certbot.bin }}"

- name: Set certbot permissions
  become: yes
  file:
    path: "{{ certbot.bin }}"
    state: file
    mode: 0755

- name: Run certbot
  become: yes
  command: "{{ certbot.bin }} --nginx certonly -q -d {{ item }} --email {{ certbot.email }} --agree-tos"
  args:
    creates: "/etc/letsencrypt/live/{{ item }}"
  with_items: "{{ nginx.vhosts.values() | map(attribute='server_name') | list }}"

- name: Install certbot cronjob
  become: yes
  cron:
    name: renew letsencrypt certificates
    special_time: daily
    user: root
    cron_file: certbot
    job: "{{ certbot.bin }} -q renew"

- name: Install nginx
  become: yes
  include_role:
    name: geerlingguy.nginx
  vars:
    nginx_vhosts: "{{ nginx.vhosts.values() }}"
