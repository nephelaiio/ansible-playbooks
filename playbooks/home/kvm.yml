- name: configure kvm hosts

  hosts: kvm

  vars:

    cleanup: False
    
  tasks:
    
    - name: install requirements
      package:
        name:
          - qemu
          - libvirt
          - libvirt-python
          - bridge-utils
          - dnsmasq
          - ebtables
          - dmidecode
          - cloud-init
          - cdrtools
          - python-lxml
        update_cache: yes
      when: ansible_os_family == "Archlinux"
      become: yes

    - name: clear bridging configuration
      file:
        path: "{{ item }}"
        state: absent
      become: yes
      with_items:
        - "{{ kvm.bridge_config }}"
        - "/etc/systemd/system/sysctl-bridge.service"

    - name: configure bridging
      sysctl:
        name: "{{ item }}"
        value: 0
        state: present
        sysctl_set: yes
        reload: yes
      become: yes
      with_items:
        - net.bridge.bridge-nf-call-ip6tables
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-arptables

    - name: fetch images
      local_action: >-
        get_url
        url="{{ item.value.src }}"
        dest="../../files/{{ item.value.img }}"
        mode=0644
      with_dict: "{{ kvm.images }}"
      notify: uncompress images

    - meta: flush_handlers

    - include: kvm/tasks/pool_create.yml
      vars:
        pool: "{{ kvm.defaults.pool | combine({'name': item.key},  item.value) }}"
      with_dict: "{{ kvm.pools }}"
      static: no

    - include: kvm/tasks/vm_destroy.yml
      vars:
        vm: "{{ kvm.defaults.vm | combine(item, recursive='true') }}"
        pool: "{{ kvm.pools[vm.pool].path }}"
        iso: "{{ pool }}/cloud_init_{{ vm.name }}.iso"
      with_items: "{{ kvm.vms }}"
      static: no

    - include: kvm/tasks/vm_create.yml
      vars:
        vm: "{{ kvm.defaults.vm | combine(item, recursive='true') }}"
        img: "{{ kvm.images[vm.image].img }}"
        pool: "{{ kvm.pools[vm.pool].path }}"
        iso: "{{ pool }}/cloud_init_{{ vm.name }}.iso"
      with_items: "{{ kvm.vms }}"
      static: no

    - include: kvm/tasks/vm_register.yml
      vars:
        vm: "{{ item }}"
      with_items: "{{ kvm.vms }}"

  handlers:

    - name: uncompress images
      local_action: >-
        command qemu-img convert -O qcow2 {{ img }} {{ img }}
        chdir="../../files"
      vars:
        img: "{{ item.value.img }}" 
      with_dict: "{{ kvm.images }}"

    - name: configure bridge
      command: "sysctl -p {{ kvm.bridge_config }}"
      become: yes
