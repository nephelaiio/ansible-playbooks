# vim: ts=2 sw=2 et :
---
- hosts: dns,recursor

  name: gather facts from dns servers

  tasks: [ ]


- hosts: dhcp

  vars:

    local_fwd_zones: "{{ dns.zones.values() | map(attribute='name') | list }}"

  become: yes

  tasks:

    - name: Inspect nameservers
      changed_when: False
      command: "host -W 1 www.google.com"
      ignore_errors: true
      register: resolv

    - name: Configure resolution
      include_role:
        name: ahuffman.resolv
      vars:
        resolv_nameservers:
          - 8.8.8.8
          - 8.8.4.4
      when: resolv.rc != 0

    - name: Install dhcpd
      package:
        name: "{{ item }}"
        state: latest
      become: yes
      with_items:
        - isc-dhcp-server
      notify: Restart dhcpd

    - name: Configure dhcp
      template:
        src: ../../templates/dhcp/dhcpd.conf.j2
        dest: /etc/dhcp/dhcpd.conf
      become: yes
      vars:
        tsigkey: "{{ tsigkeys.dhcp }}"
        omapikey: "{{ tsigkeys.omapi }}"
        lease_time: 600 
        networks: "{{ nets.values() }}"
        zones: "{{ dns.zones.values() }}"
        failover: "{{ dhcp.failover }}"
      notify: Restart dhcpd

    - name: Configure resolution
      include_role:
        name: ahuffman.resolv
      vars:
        resolv_nameservers: "{{ dns.recursors }}"

  handlers:

    - name: Restart dhcpd
      service:
        name: isc-dhcp-server
        state: restarted
      become: yes
    
