# vim: ts=2 sw=2 et :
---
- hosts: home

  name: gather facts

  tasks: [ ]


- hosts: dhcp

  vars:
 
    kea_dhcp_config: true
    kea_dhcp_dhcp4_config:
      Dhcp4:
        dhcp-ddns:
          enable-updates: true
          qualifying-suffix: "{{ dns.zones.home.name }}"
        subnet4:
          - "{{ nets.home }}"
        
    kea_dhcp_ddns_config:
      DhcpDdns:
        ip-address: "{{ dns.server }}"
        port: 53
        tsig-keys:
          - "{{ tsigkeys.dhcp.name }}"
        forward-ddns:
          ddns-domains:
            - "{{ dns.zones.home.name }}"

    local_fwd_zones: "{{ dns.zones.values() | map(attribute='name') | list }}"

  become: yes

  tasks:

    - name: Inspect nameservers
      changed_when: False
      command: "host -W 1 www.google.com"
      ignore_errors: true
      register: resolv

    - name: Configure resolution
      include_role:
        name: ahuffman.resolv
      vars:
        resolv_nameservers:
          - 8.8.8.8
          - 8.8.4.4
      when: resolv.rc != 0

    - name: Install dhcpd
      package:
        name: "{{ item }}"
        state: latest
      become: yes
      with_items:
        - isc-dhcp-server
      notify: Restart dhcpd

    - name: Configure resolution
      include_role:
        name: ahuffman.resolv
      vars:
        resolv_nameservers: "{{ local_fwd_zones }}"
      when: resolv.rc != 0

  handlers:

    - name: Restart dhcpd
      service:
        name: isc-dhcp-server
        state: restarted
      become: yes
    
