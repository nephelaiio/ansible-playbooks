# vim: ts=2 sw=2 et :
---
- hosts: dns

  name: gather facts from dns servers

  tasks: [ ]


- hosts: recursor

  vars:

    pdns_rec_config:
      local-address:
        - '*:53'
      forward-zones:
        - "home.nephelai.io={{ hostvars[groups['dns']] | first | map(attribute='ansible_default_ipv4') }}:53"

    local_fwd_zones: "{{ dns.zones.values() | map(attribute='name') | list }}"

    local_rev_zones: "{{ nets.values() | map(attribute='zone') | list }}"

  become: yes

  tasks:

    - name: Inspect nameservers
      changed_when: False
      command: "host -W 1 www.google.com"
      ignore_errors: true
      register: resolv

    - name: Configure resolution
      include_role:
        name: ahuffman.resolv
      vars:
        resolv_nameservers:
          - 8.8.8.8
          - 8.8.4.4
      when: resolv.rc != 0

    - name: Install bind
      apt:
        name: "{{ item }}"
        state: latest
        force: yes
      become: yes
      with_items:
        - dnsutils
        - bind9
      notify: Restart bind

    - name: Configure bind rfc-1918 zones
      lineinfile:
        path: /etc/bind/zones.rfc1918
        regexp: "{{ item }}"
        state: absent
      become: yes
      with_items: "{{ local_rev_zones }}"
      notify: Restart bind

    - name: Configure bind custom zones
      template:
        src: ../../templates/bind/recursor.conf.j2
        dest: /etc/bind/named.conf.local
      become: yes
      notify: Restart bind

    - name: Configure bind services
      service:
        name: "{{ item }}"
        enabled: yes
        state:  started
      with_items:
        - bind9
        - bind9-resolvconf
      become: yes

  handlers:

    - name: Restart bind
      service:
        name: bind9
        state: restarted
      become: yes
