---
- hosts: "{{ target_hosts | default('recursor') }}"

  vars:

    zones:
      fwd: "{{ dns.zones.values() | map(attribute='name') | list }}"
      rev: "{{ nets.values() | map(attribute='zone') | list }}"

  become: yes

  tasks:

    - name: Inspect nameservers
      changed_when: False
      command: "host -W 1 www.google.com"
      ignore_errors: true
      register: resolv

    - name: Configure resolution
      include_role:
        name: ahuffman.resolv
      vars:
        resolv_nameservers:
          - 8.8.8.8
          - 8.8.4.4
      when: resolv.rc != 0

    - name: Install bind
      apt:
        name: "{{ item }}"
        state: latest
        force: yes
      with_items:
        - dnsutils
        - bind9
      notify: Restart bind

    - name: Disable ipv6 resolution
      lineinfile:
        regexp: '^OPTIONS='
        line: 'OPTIONS="-u bind -4"'
        dest: /etc/default/bind9
      notify: Restart bind

    - name: Configure bind rfc-1918 zones
      lineinfile:
        path: /etc/bind/zones.rfc1918
        regexp: "{{ item }}"
        state: absent
      with_items: "{{ zones.rev }}"
      notify: Restart bind

    - name: Configure bind custom zones
      template:
        src: ../../templates/bind/recursor.conf.j2
        dest: /etc/bind/named.conf.local
      vars:
        fwd_zones: "{{ zones.fwd }}"
      notify: Restart bind

    - name: Configure bind services
      service:
        name: "{{ item }}"
        enabled: yes
        state: started
      with_items:
        - bind9

    - name: Configure resolution
      include_role:
        name: ahuffman.resolv
      vars:
        resolv_nameservers:
          - 127.0.0.1

  handlers:

    - name: Restart bind
      service:
        name: "{{ item }}"
        state: restarted
      with_items:
        - bind9
