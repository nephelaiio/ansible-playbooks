---
- name: Upgrade hosts
  hosts: raspberry
  tasks:
    - include: home/raspberry.yml
    - include: upgrade.yml

- include: sensu/server.yml
  vars:
    target_hosts: rpic

- include: bind/recursor.yml
  vars:
    target_hosts: recursor

- include: pdns/server.yml
  vars:
    target_hosts: rpic

- include: home/dhcp.yml
  vars:
    target_hosts: dhcp

- name: Configure Unifi Controller
  hosts: rpib
  vars:
    certbot:
      bin: /usr/bin/certbot
      url: https://dl.eff.org/certbot-auto
      checksum: "sha256:5bcd76b4b4741346a9ea94b15ddd574b9568e424a7315f0d5a840f10f0153dbe"
      email: teodoro.cook@gmail.com
      certdir: /etc/letsencrypt/live
    nginx:
      vhosts:
        home_https:
          listen: "443 ssl"
          server_name: home.nephelai.io
          filename: home.nephelai.io.https.conf
          root: /var/www/html/unifi
          access_log: /var/log/nginx/home.nephelai.io.access.log
          error_log: /var/log/nginx/home.nephelai.io.error.log
          ssl_ciphers: "ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5"
          extra_parameters: |
            keepalive_timeout   300;
            ssl_certificate {{ certbot.certdir }}/home.nephelai.io/fullchain.pem;
            ssl_certificate_key {{ certbot.certdir }}/home.nephelai.io/privkey.pem;
            ssl_session_cache   shared:SSL:10m;
            ssl_session_timeout 10m;
            ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
            ssl_prefer_server_ciphers on;
            ssl_stapling on;
            ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA;
            add_header Strict-Transport-Security max-age=31536000;
            add_header X-Frame-Options DENY;
            error_log /var/log/unifi/nginx.log;
            proxy_cache off;
            proxy_store off;
            location / {
                proxy_pass https://unifi.home.nephelai.io:8443/;
                }
        home_http:
          listen: "80"
          server_name: home.nephelai.io
          filename: home.nephelai.io.http.conf
          root: /var/www/html/unifi
          access_log: /var/log/nginx/home.nephelai.io.http.access.log
          error_log: /var/log/nginx/home.nephelai.io.http.error.log
          extra_parameters: |
            rewrite ^/unifi(.*) https://home.nephelai.io/unifi$1 permanent;
  tasks:
    - include: home/unifi.yml 

- name: Configure nfs
  hosts: rpia
  tasks:
    - include: home/nfs.yml

- name: Configure workstation
  hosts: cerberus
  tasks:
    - include: workstation.yml
