---
- name: Configure dhcp servers

  hosts: "{{ dhcp_hosts | default('dhcp') }}"

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: install dhcpd
      apt:
        name: isc-dhcp-server
        state: latest
      notify: restart dhcpd

    - name: configure dhcp interfaces
      template:
        src: defaults.conf.j2
        dest: /etc/default/isc-dhcp-server
      vars:
        iface: "{{ ansible_default_ipv4.interface }}"
      notify: restart dhcpd

    - name: configure dhcp daemon
      template:
        src: dhcpd.conf.j2
        dest: /etc/dhcp/dhcpd.conf
      vars:
        omapikey: "{{ tsigkeys.omapi }}"
        lease_time: 1800
        networks: "{{ nets.values() | list }}"
        failover: "{{ dhcp_failover | default([]) }}"
        domain_name: "{{ dns_zones.management.name }}"
      notify: restart dhcpd

    - name: configure dhcp leases permissions
      file:
        dest: /var/lib/dhcp/dhcpd.leases
        owner: "{{ dhcp_user }}"
        group: "{{ dhcp_group }}"
        mode: 0660
        state: touch
      notify: restart dhcpd

    - name: manage services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - isc-dhcp-server

  handlers:

    - name: restart dhcpd
      service:
        name: "{{ item }}"
        state: restarted
      with_items:
        - isc-dhcp-server
