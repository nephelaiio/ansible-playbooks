---
- name: Configure dhcp reservations

  hosts: all:!foreman_guests:!networking

  gather_facts: no

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include global variables
      include_vars:
        dir: "../{{ variables }}"
      delegate_to: localhost
      run_once: yes

    - name: add reservation
      lineinfile:
        path: /etc/dhcp/dhcpd.conf
        line: "host {{ inventory_hostname }} { {{ stanza_hw_address }}; {{ stanza_fixed_address }}; {{ stanza_domain_name }}; {{ stanza_host_name }}; }"
      vars:
        stanza_hw_address: "hardware ethernet {{ hw_address }}"
        stanza_fixed_address: "fixed-address {{ ansible_host }}"
        stanza_domain_name: "option domain-name \"{{ inventory_hostname | split_with('.') | tail | join('.') }}\""
        stanza_host_name: "option host-name \"{{ inventory_hostname | split_with('.') | head }}\""
      delegate_to: "{{ item }}"
      with_items: "{{ groups.dhcp }}"
      when:
        - hw_address is defined
        - inventory_hostname not in groups.offline
      notify: restart dhcpd

  handlers:

    - name: restart dhcpd
      service:
        name: isc-dhcp-server
        state: restarted
      delegate_to: "{{ item }}"
      with_items: "{{ groups.dhcp }}"
      run_once: yes
