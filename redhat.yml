---
- name: create centos aarch64 images

  hosts: mirror

  become: yes

  vars:

    redhat_release: fedora
    redhat_inventory_group: raspberry
    redhat_user_pubkey: "{{ users.teddyphreak.pubkey }}"
    redhat_user: root

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "{{ variables }}"

    - name: install requirements
      package:
        name:
          - xz-utils
          - parted

    - name: define redhat image path
      set_fact:
        redhat_image_path: "{{ mirror_root }}/{{ redhat_releases[redhat_release].url | urlsplit('path') | dirname }}"

    - name: define redhat image archive
      set_fact:
        redhat_local_image: "{{ redhat_image_path }}/{{ redhat_releases[redhat_release].url | urlsplit('path') | basename }}"

    - name: create redhat image target directory
      file:
        state: directory
        path: "{{ redhat_local_image | dirname }}"

    - name: fetch redhat source image
      get_url:
        url: "{{ redhat_releases[redhat_release].src }}"
        dest: "{{ redhat_local_image }}"

    - name: create redhat images
      include_tasks: redhat/image_create.yml
      vars:
        redhat_host:
          hostname: "{{ hostitem }}"
          ifaces:
            - name: eth0
              method: static
              ip-address: "{{ hostvars[hostitem]['ansible_host'] }}"
              prefix: "{{ nets.home.netmask }}"
              gateway: "{{ nets.home.router }}"
        redhat_source_image: "{{ redhat_local_image }}"
        redhat_target_image_path: "{{ redhat_image_path }}"
      loop_control:
        loop_var: hostitem
      with_items: "{{ groups[redhat_inventory_group] }}"
