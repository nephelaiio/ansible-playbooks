---
- name: Set up samba domain controller

  hosts: samba

  roles:

    - nephelaiio.plugins

  become: yes

  tasks:

    - name: include private variables
      include_vars:
        dir: "{{ variables }}"

    - name: install packages
      package:
        name:
          - samba
          - krb5-user
          - krb5-config
          - winbind
          - libpam-winbind
          - libnss-winbind
          - dnsutils
        state: present

    - name: disable non essential daemons
      service:
        name: "{{ item }}"
        state: stopped
        enabled: no
      with_items:
        - smbd
        - nmbd
        - winbind

    - name: unmask samba ad daemon
      command: systemctl unmask samba-ad-dc
      args:
        warn: false
      changed_when: false
