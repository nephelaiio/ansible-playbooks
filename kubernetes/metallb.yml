---
- name: Deploy metallb

  hosts: localhost

  vars:

    metallb_release: v0.7.3
    metallb_manifest_url: "https://raw.githubusercontent.com/google/metallb/{{ metallb_release }}/manifests/metallb.yaml"

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

    - name: deploy mtallb manifest
      command: "kubectl apply -f {{ metallb_manifest_url }}"

    - name: configure metallb
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            namespace: metallb-system
            name: config
          data:
            config: |
              address-pools:
              - name: "{{ nets.home.lb.name }}"
                protocol: layer2
                addresses:
                  - "{{ nets.home.lb.range | regex_replace(' ', '-') }}"
