---
- name: Deploy awx

  hosts: localhost

  become: no

  vars:

    awx_root: ./awx
    awx_namespace: awx
    awx_task_hostname: awx
    awx_web_hostname: awxweb

  roles:

    - nephelaiio.plugins

  pre_tasks:

    - name: include private variables
      include_vars:
        dir: "../{{ variables }}"

  tasks:

    - name: clone awx repository
      git:
        repo: https://github.com/ansible/awx.git
        version: "{{ awx_release }}"
        dest: "{{ awx_root }}"
        force: yes
      when: false

    - block:

      - name: create helm temp dir
        tempfile:
          state: directory
          suffix: metallb
        register: helm_dir

      - name: install awx kubernetes role
        include_role:
          name: kubernetes
        vars:
          dockerhub_version: "{{ awx_release }}"
          dockerhub_base: ansible
          kubernetes_context: "kubernetes-admin@{{ k8s_cluster_name }}" 
          kubernetes_deployment_name: awx
          kubernetes_namespace: "{{ awx_namespace }}"
          task_cpu_requests: 2000
          task_mem_request: 8
          create_preload_data: no
          pg_username: "{{ awx_pg_user }}"
          pg_password: "{{ awx_pg_pass }}"
          pg_database: "awx_{{ awx_release }}"
          pg_port: 5432
          admin_user: "{{ awx_admin_user }}"
          admin_password: "{{ awx_admin_pass }}"
          secret_key: "{{ awx_secret_key }}"

      - include_tasks: ./resource.yml
        loop_control:
          loop_var: k8s_resource
        with_items:

          - description: awx ingress
            recreate: yes
            definition:
              apiVersion: extensions/v1beta1
              kind: Ingress
              metadata:
                name: awx-web-svc
                namespace: "{{ awx_namespace }}"
                annotations:
                  kubernetes.io/ingress.class: traefik
                  external-dns.alpha.kubernetes.io/target: "{{ traefik_target }}"
              spec:
                rules:
                  - host: "{{ awx_url | urlsplit('hostname') }}"
                    http:
                      paths:
                        - backend: 
                            serviceName: awx-web-svc
                            servicePort: 80

      always:

        - name: destroy helm temp dir
          file:
            state: absent
            path: "{{ helm_dir.path }}"
