---
- name: Configure dhcp servers

  hosts: dhcp

  become: yes

  vars:

    dhcp_nets: "{{ nets.home }}"
    dhcp_zones: "{{ dns.zones.values() }}"
    local_fwd_zones: "{{ dns.zones.values() | map(attribute='name') | list }}"

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include global variables
      include_vars:
        dir: "{{ variables }}"

    - name: install dhcpd
      apt:
        name: isc-dhcp-server
        state: latest
      notify: restart dhcpd

    - name: configure dhcp interfaces
      template:
        src: templates/dhcp/defaults.conf.j2
        dest: /etc/default/isc-dhcp-server
      vars:
        iface: "{{ ansible_default_ipv4.interface }}"
      notify: restart dhcpd

    - name: configure dhcp daemon
      template:
        src: templates/dhcp/dhcpd.conf.j2
        dest: /etc/dhcp/dhcpd.conf
      vars:
        omapikey: "{{ tsigkeys.omapi }}"
        lease_time: 1800
        networks: "{{ nets.values() }}"
        zones: "{{ dhcp_zones }}"
        failover: "{{ dhcp_failover }}"
        domain_name: "{{ dns.zones.home.name }}"
      notify: restart dhcpd

    - name: manage services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - isc-dhcp-server

  handlers:

    - name: restart dhcpd
      service:
        name: "{{ item }}"
        state: restarted
      with_items:
        - isc-dhcp-server


- name: Configure dhcp reservations

  hosts: all

  gather_facts: no

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include global variables
      include_vars:
        dir: "{{ variables }}"

    - name: gather_facts
      setup:
      when: inventory_hostname not in groups.offline

    - name: add reservation
      lineinfile:
        path: /etc/dhcp/dhcpd.conf
        line: "host {{ inventory_hostname }} { {{ stanza_hw_address }}; {{ stanza_fixed_address }}; {{ stanza_domain_name }}; {{ stanza_host_name }}; }"
      vars:
        stanza_hw_address: "hardware ethernet {{ hw_address }}"
        stanza_fixed_address: "fixed-address {{ ansible_host }}"
        stanza_domain_name: "option domain-name \"{{ inventory_hostname | split_with('.') | tail | join('.') }}\""
        stanza_host_name: "option host-name \"{{ inventory_hostname | split_with('.') | head }}\""
      delegate_to: "{{ item }}"
      with_items: "{{ groups.dhcp }}"
      when:
        - hw_address is defined
        - inventory_hostname not in groups.offline
      notify: restart dhcpd

  handlers:

    - name: restart dhcpd
      service:
        name: isc-dhcp-server
        state: restarted
      delegate_to: "{{ item }}"
      with_items: "{{ groups.dhcp }}"
      run_once: yes
