---
- name: Configure backup destination

  hosts: backup

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: create backup targets
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default(omit) }}"
        group: "{{ item.group | default(omit) }}"
        mode: "{{ item.mode | default(omit) }}"
      loop: "{{ nfs_export_data }}"

    - name: build export entries
      set_fact:
        nfs_exports: "{{ (nfs_exports | default([])) + [item.path + ' ' + item.options] }}"
      loop: "{{ nfs_export_data }}"

    - name: install and configure nfs
      include_role:
        name: nephelaiio.nfs

    - name: export filesystems
      command: exportfs -a
      changed_when: false

    - name: update backup pdns record
      uri:
        url: "{{ pdns_url }}/api/v1/servers/localhost/zones/{{ backup_fqdn_zone }}"
        method: PATCH
        return_content: yes
        body_format: json
        body:
          rrsets:
            - name: "{{ backup_fqdn_host }}"
              type: A
              ttl: 3600
              changetype: REPLACE
              records:
                - content: "{{ ansible_host | default(ansible_default_ipv4.address) }}"
                  disabled: no
                  comments: []
        headers:
          X-API-Key: "{{ pdns_api_key }}"
        status_code: 204
      vars:
        backup_fqdn_host: "{{ backup_host }}."
        backup_fqdn_zone: "{{ backup_host | split_with('.') | tail | join('.') }}"
      register: pdns_zones_query
