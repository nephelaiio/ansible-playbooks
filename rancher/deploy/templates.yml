---
- name: build deployment templates

  hosts: localhost

  tasks:

    - name: list templates
      find:
        paths: "{{ template_dir }}"
        file_type: file
        patterns:
          - "*.j2"
          - "*.j2.yml"
        recurse: yes
      register: template_files

    - name: create render directories
      file:
        state: directory
        path: "{{ item | dirname }}/insecure"
      loop_control:
        label: "{{ item | dirname }}/insecure"
      loop: "{{ template_files.files | map(attribute='path') | list }}"

    - name: render templates
      template:
        src: "{{ item }}"
        dest: "{{ item | dirname }}/insecure/{{ item | basename | regex_replace('\\.j2', '') }}"
      loop_control:
        label: "{{ item | dirname }}/insecure/{{ item | basename | regex_replace('\\.j2', '') }}"
      loop: "{{ template_files.files | map(attribute='path') | list }}"
