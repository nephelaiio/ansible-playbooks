---
- name: Create KVM guests

  hosts: kvm

  vars:

    iptables_savefile: /etc/iptables/iptables.rules
    nat_in: br1
    nat_out:
      - br0
    apt_mirror: apt.home.nephelai.io

  roles:

    - nephelaiio.plugins

  tasks:

    - name: configure bridging
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_set: yes
        reload: yes
      with_items:
        - name: net.bridge.bridge-nf-call-ip6tables
          value: 0
        - name: net.bridge.bridge-nf-call-iptables
          value: 0
        - name: net.bridge.bridge-nf-call-arptables
          value: 0
        - name: net.ipv4.ip_forward
          value: 1
      become: yes

    - name: install pacman requirements
      package:
        name:
          - qemu
          - libvirt
          - libvirt-python
          - bridge-utils
          - dnsmasq
          - ebtables
          - dmidecode
          - cloud-init
          - cdrtools
          - python-lxml
          - dhcp
        update_cache: yes
      become: yes
      when: ansible_os_family == 'Archlinux'

    - name: install apt requirements
      package:
        name:
          - qemu-kvm
          - qemu-utils
          - libvirt0
          - python-libvirt
          - bridge-utils
          - ebtables
          - dmidecode
          - python-lxml
          - genisoimage
          - isc-dhcp-server
      become: yes
      when: ansible_os_family == 'Debian'

    - name: configure dhcp
      template:
        src: dhcp/dhcpd.conf.j2
        dest: /etc/dhcpd.conf
      vars:
        lease_time: 1800
        networks:
          - "{{ nets.private }}"
        zones: "{{ dns.zones.values() }}"
      notify: restart dhcpd
      become: yes

    - meta: flush_handlers

    - name: manage services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      become: yes
      with_items:
        - dhcpd4  # dhcpd4 (arch) | isc-dhcp-server (debian)

    - name: initialize iptables configuration
      file:
        path: "{{ iptables_savefile }}"
        state: touch
      become: yes

    - name: configure nat
      iptables:
        table: nat
        chain: POSTROUTING
        out_interface: "{{ item }}"
        jump: MASQUERADE
      become: yes
      with_items: "{{ nat_out }}"

    - name: configure nat
      iptables:
        chain: FORWARD
        in_interface: "{{ item }}"
        out_interface: "{{ nat_in }}"
        match: state
        ctstate: RELATED,ESTABLISHED
        jump: ACCEPT
      become: yes
      with_items: "{{ nat_out }}"

    - name: configure nat
      iptables:
        chain: FORWARD
        in_interface: "{{ nat_in }}"
        out_interface: "{{ item }}"
        jump: ACCEPT
      become: yes
      with_items: "{{ nat_out }}"

    - name: save iptables configuration
      shell: "iptables-save > {{ iptables_savefile }}"
      become: yes

    - name: install apt requirements
      package:
        name:
          - qemu-kvm
          - qemu-utils
          - libvirt0
          - python-libvirt
          - bridge-utils
          - ebtables
          - dmidecode
          - python-lxml
          - genisoimage
      become: yes
      when: ansible_os_family == 'Debian'

    - name: install pacman requirements
      package:
        name:
          - qemu
          - libvirt
          - libvirt-python
          - bridge-utils
          - ebtables
          - dmidecode
          - python-lxml
          - cdrtools
      become: yes
      when: ansible_os_family == 'Archlinux'

    - name: create image target directory
      file:
        path: files/kvm
        state: directory

    - name: fetch images
      get_url:
        url: "{{ item.value.src }}"
        dest: "files/kvm/{{ item.value.src | basename }}"
        mode: 0644
      with_dict: "{{ kvm_images }}"

    - name: uncompress images
      command: "qemu-img convert -O {{ format }} {{ img }} {{ target }}"
      args:
        chdir: "files/kvm"
        creates: "{{ target }}"
      vars:
        format: "{{ item.value.format }}"
        img: "{{ item.value.src | basename }}"
        target: "{{ item.value.src | basename | with_ext(item.value.format) }}"
      with_dict: "{{ kvm_images }}"

    - meta: flush_handlers

    - name: destroy VMs
      include_tasks: kvm/vm_destroy.yml
      vars:
        vm: "{{ kvm.defaults.vm | combine(item, recursive='true') }}"
        pool: "{{ kvm.pools[vm.pool].path }}"
        iso: "{{ pool }}/cloud_init_{{ vm.name }}.iso"
      with_items: "{{ kvm.vms.values() }}"

    - name: create VMs
      include_tasks: kvm/vm_create.yml
      vars:
        vm: "{{ kvm.defaults.vm | combine(item, recursive='true') }}"
        img: "{{ kvm_images[vm.image].src | basename | with_ext(kvm_images[vm.image].format) }}"
        pool: "{{ kvm.pools[vm.pool].path }}"
        iso: "{{ pool }}/cloud_init_{{ vm.name }}.iso"
      with_items: "{{ kvm.vms.values() }}"

  handlers:

    - name: restart dhcpd
      service:
        name: "{{ item }}"
        state: restarted
      become: yes
      with_items:
        - dhcpd4  # dhcpd4 (arch) | isc-dhcp-server (debian)
