---
awx_release: "5.0.0"
awx_hostname: "{{ awx_url | urlsplit('hostname') }}"
awx_port: 8080
awx_nolog: yes
awx_admin_user: "{{ secret_awx_admin_user }}"
awx_admin_pass: "{{ secret_awx_admin_pass }}"
awx_key: "{{ secret_awx_key }}"
awx_host_key: "{{ secret_awx_host_key }}"
awx_pg_user: "{{ secret_awx_pg_user }}"
awx_pg_pass: "{{ secret_awx_pg_pass }}"
awx_secret_key: "{{ secret_awx_secret_key }}"
awx_github_user: "{{ secret_awx_github_user }}"
awx_github_pass: "{{ secret_awx_github_pass }}"
awx_vault_home_pass: "{{ secret_awx_vault_home_pass }}"
rabbitmq_user: awx
rabbitmq_password: "{{ secret_awx_rabbitmq_password }}"
rabbitmq_erlang_cookie: "{{ secret_awx_rabbitmq_erlangcookie }}"

awx_organizations:

  - name: home
    state: present

    credentials:
      - name: github.com
        kind: scm
        inputs:
          username: "{{ awx_github_user }}"
          password: "{{ awx_github_pass }}"
      - name: home.vault
        kind: vault
        inputs:
          vault_password: "{{ awx_vault_home_pass }}"
      - name: home.ssh
        kind: ssh
        inputs:
          username: "{{ users.teddyphreak.username }}"
          ssh_key_data: "{{ users.teddyphreak.privkey }}"

    projects:
      - name: nephelai.io
        scm_type: git
        scm_url: https://github.com/nephelaiio/ansible-playbooks.git
        scm_branch: master
        scm_delete_on_update: false
        scm_credential: github.com
        scm_update_on_launch: true
        scm_update_cache_timeout: 60
        scm_clean: false

    inventories:
      - name: home
        source: scm
        source_project: nephelai.io
        source_path: inventory
        overwrite: true
        overwrite_vars: true
        update_on_launch: true
        update_on_project_update: false

    templates:
      - name: ping.home
        job_type: run
        project: nephelai.io
        inventory: home
        playbook: ping.yml
        vault_credential: home.vault
        credential: home.ssh
      - name: upgrade.home
        job_type: run
        project: nephelai.io
        inventory: home
        playbook: upgrade.yml
        vault_credential: home.vault
        credential: home.ssh
      - name: dhcp.home
        job_type: run
        project: nephelai.io
        inventory: home
        playbook: dhcp.yml
        vault_credential: home.vault
        credential: home.ssh
        host_config_key: "{{ awx_host_key }}"
      - name: dns.home
        job_type: run
        project: nephelai.io
        inventory: home
        playbook: dns.yml
        vault_credential: home.vault
        credential: home.ssh
        host_config_key: "{{ awx_host_key }}"

    workflows:
      - name: home
        nodes:
          - name: upgrade
            template: upgrade.home
            parent: os
          - name: dns
            template: dns.home
            parent: mirror
          - name: dhcp
            template: dhcp.home
            parent: dns

    schedules:
      - name: home
        job_template: home
        enabled: true
        rrule: "DTSTART:20180826T000000Z RRULE:FREQ=DAILY;INTERVAL=1"
        state: absent
