---
- block:

  - name: destroy vms
    virt:
      name: "{{ vm.name }}"
      command: destroy
    failed_when: false

  - name: undefine vms
    virt:
      name: "{{ vm.name }}"
      command: undefine
    failed_when: false

  - name: delete vm disk
    file:
      path: "{{ pool }}/{{ vm.name }}.img"
      state: absent
    become: yes

  - name: delete cloud image disk
    file:
      path: "{{ iso }}"
      state: absent
    become: yes

  - name: delete qemu definitions
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - "/etc/libvirt/qemu/{{ vm.name }}.xml"
      - "/etc/libvirt/qemu/autostart/{{ vm.name }}.xml"
      - "/var/lib/libvirt/images/cloud_init_{{ vm.name }}.xml"
      - "/var/lib/libvirt/images/cloud_init_{{ vm.name }}.iso"
      - "/var/lib/libvirt/images/{{ vm.name }}.img"
    become: yes

  when: vm.state in ['absent', 'recreate']
