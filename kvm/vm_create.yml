---
- name: Get user
  local_action: command whoami
  changed_when: False
  register: ansible_username

- name: Create temporary directory
  tempfile:
    state: directory
    prefix: kvm_{{ vm.name}}_
  register: tmpdir
  changed_when: False

- name: Set image var path
  set_fact:
    disk: "{{ pool }}/{{ vm.name }}.img"

- name: Copy vm disk
  copy:
    src: "files/kvm/{{ img }}"
    dest: "{{ disk }}"
    force: no
    mode: 0644
    owner: "{{ ansible_username.stdout }}"
  when: vm.state in ['present', 'recreate']
  register: diskcopy
  become: yes

- name: resize vm disk
  command: "qemu-img resize {{ disk }} {{ vm.size }}"
  when: diskcopy.changed

- name: create cloud image user data
  template:
    src: kvm/user-data.yml.j2
    dest: "{{ tmpdir.path }}/user-data"
  vars:
    ssh_user: "{{ ansible_username.stdout }}"
    ssh_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
    hostname: "{{ vm.name.split('.') | first }}"
    fqdn: "{{ vm.nic.host }}"
    iface: "{{ vm.nic }}"
    # apt_proxy_http_uri: ''
    # apt_proxy_https_uri: ''
    apt_mirror: "{{ ansible_default_ipv4.address }}"
  when: diskcopy.changed

- name: create cloud image network config
  template:
    src: kvm/network-config.yml.j2
    dest: "{{ tmpdir.path }}/network-config"
  vars:
    iface: "{{ vm.nic }}"
  when: diskcopy.changed

- name: create cloud image meta data
  template:
    src: kvm/meta-data.yml.j2
    dest: "{{ tmpdir.path }}/meta-data"
  vars:
    instance_id: "{{ vm.name.split('.') | first }}"
    hostname: "{{ vm.name.split('.') | first }}"
    fqdn: "{{ vm.nic.host }}"
  when: diskcopy.changed

- name: create cloud image iso
  command: genisoimage -output {{ iso }} -volid cidata -joliet -r meta-data user-data network-config
  args:
    chdir: "{{ tmpdir.path }}"
  when: diskcopy.changed
  become: yes

- name: set vm definition path
  set_fact:
    domain_def: "{{ tmpdir.path }}/vm_{{ vm.name }}.xml"

- name: create vm templates
  template:
    src: kvm/vm.xml.j2
    dest: "{{ domain_def }}"

- name: create vms
  virt:
    name: "{{ vm.name }}"
    command: define
    xml: "{{ lookup('file', domain_def) }}"
  when: diskcopy.changed

- name: manage vms
  virt:
    name: "{{ vm.name }}"
    state: "{{ state }}"
    xml: "{{ tpl }}"
  vars:
    state: "{{ vm.state | regex_replace('recreate', 'running') | regex_replace('present', 'running') }}"
    tpl: "{{ lookup('template', tmpdir.path + '/vm_' + vm.name + '.xml') }}"
  when: vm.state in ['present', 'recreate', 'running']
  become: yes

- name: autostart vm
  command: "virsh -c qemu:///system autostart {{ vm.name }}"
  changed_when: false
  become: yes
  when: vm.state in ['present', 'recreate', 'running'] and vm.autostart

- name: remove temporary directory
  file:
    path: "{{ tmpdir.path }}"
    state: absent
  changed_when: false
