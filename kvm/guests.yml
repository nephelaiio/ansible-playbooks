---
- name: Create kvm guests

  hosts: kvm_guests

  become: yes

  gather_facts: no

  vars:

    ansible_kvm_user: teddyphreak
    kvm_nolog: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: manage vms
      import_tasks: vm_manage.yml
      vars:
        guest_name: "{{ inventory_hostname }}"
        ansible_guest_user: "{{ users[ansible_kvm_user] }}"
        ansible_guest_username: "{{ ansible_guest_user.username }}"
        ansible_guest_password: "{{ ansible_guest_user.password }}"
        ansible_guest_ssh_key: "{{ ansible_guest_user.pubkey }}"
        img_dir: "{{ playbook_dir }}/../files/kvm"
