---
- name: Configure dns recursors

  hosts: recursors

  become: yes

  vars:

    bind_fwd_zones: "{{ dns.zones.values() | map(attribute='name') | list }}"
    bind_conf_local: "{{ bind_fwd_zones | map('zone_fwd', servers.dns) | list }}"

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include private variables
      include_vars:
        dir: "vars/{{ variables }}"

    - name: install bind
      include_role:
        name: nephelaiio.bind

    - name: flush cache
      command: rndc flush
      changed_when: false


- name: Configure pdns authoritative server

  hosts: pdns

  become: yes

  tasks:

    - name: include private variables
      include_vars:
        dir: "vars/{{ variables }}"

    - name: inspect nameservers
      changed_when: False
      command: "host -W 1 www.google.com"
      ignore_errors: true
      register: resolv

    - name: install dns utilities
      apt:
        update_cache: yes
        name: dnsutils
        state: latest

    - name: install mysql
      include_role:
        name: geerlingguy.mysql
      vars:
        mysql_packages:
          - mariadb-client
          - mariadb-server
          - python-mysqldb
        mysql_databases:
          - name: '{{ pdns.backends.gmysql.dbname }}'
        mysql_users:
          - name: '{{ pdns.backends.gmysql.user }}'
            password: '{{ pdns.backends.gmysql.password }}'
            priv: '{{ pdns.backends.gmysql.dbname }}.*:ALL'

    - name: create temporary directory
      tempfile:
        state: directory
        prefix: pdns
      register: tmpdir
      changed_when: false

    - name: install powerdns
      apt:
        update_cache: yes
        name: "{{ item }}"
        state: latest
      with_items:
        - pdns-server
        - pdns-backend-mysql

    - name: configure powerdns
      template:
        src: dns/pdns.conf.j2
        dest: /etc/powerdns/pdns.conf
      vars:
        config: "{{ pdns.config }}"
        backends: "{{ pdns.backends }}"
      notify: restart pdns

    - meta: clear_facts

    - name: build database initialization script
      template:
        src: dns/schema.sql.j2
        dest: "{{ tmpdir.path }}/schema.sql"
      changed_when: false

    - name: initialize database
      command: |
        mysql "{{ pdns.backends.gmysql.dbname }}" -e "
        SOURCE {{ tmpdir.path }}/schema.sql;"
      changed_when: false

    - name: build data initialization script
      changed_when: false
      template:
        src: dns/data.sql.j2
        dest: "{{ tmpdir.path }}/data.sql"
      vars:
        domains: "{{ pdns.domains }}"
        mx_ttl: 3600
        mx_priority: 10
        ns_ttl: 3600
        keys:
          - "{{ tsigkeys.dhcp }}"

    - name: override records
      command: |
        mysql "{{ pdns.backends.gmysql.dbname }}" -e "
        SOURCE {{ tmpdir.path }}/data.sql;"
      changed_when: false

    - name: remove temporary directory
      file:
        path: "{{ tmpdir.path }}"
        state: absent
      changed_when: false

  handlers:

    - name: restart pdns
      service:
        name: pdns
        state: restarted
