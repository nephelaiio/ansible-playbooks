---
- name: Register ovirt hosts

  hosts: ovirt_hosts

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - block:
        - name: Manage ovirt datacenter
          ovirt_datacenter:
            auth: "{{ ovirt_auth }}"
            name: "{{ ovirt_data_center }}"
            local: yes

        - name: Manage ovirt clusters
          ovirt_cluster:
            auth: "{{ ovirt_auth }}"
            name: "{{ ovirt_cluster }}"
            data_center: "{{ ovirt_data_center }}"

        - name: register host
          include_role:
            name: ovirt.hosts
          vars:
            hosts:
              - name: "{{ ansible_fqdn }}"
                address: "{{ ansible_fqdn }}"
                cluster: "{{ ovirt_cluster }}"
                password: "{{ ovirt_user_pass }}"

        - name: Manage ovirt logical networks
          ovirt_network:
            auth: "{{ ovirt_auth }}"
            data_center: "{{ item.data_center }}"
            name: "{{ item.name }}"
            vlan_tag: "{{ item.vlan_tag }}"
            vm_network: "{{ item.vm_network | default(omit) }}"
            clusters:
              - name: "{{ ovirt_cluster}}"
                required: yes
            wait: "{{ item.wait | default(omit) }}"
          loop_control:
            label: "{{ item.name }}"
          loop: "{{ ovirt_logical_networks }}"
          ignore_errors: yes
          when:
            - ovirt_logical_networks is defined
          tags:
            - networks

        - name: Manage ovirt host networks
          ovirt_host_network:
            auth: "{{ ovirt_auth }}"
            name: "{{ ansible_fqdn }}"
            interface: "{{ ovirt_host_network_iface | default(ansible_default_ipv4.interface) }}"
            networks: "{{ ovirt_host_networks }}"
          tags:
            - networks

      when: ovirt_register_host | default('yes') | bool
      delegate_to: localhost
