---
- name: Install ovirt hosts

  hosts: ovirt_hosts

  become: yes

  vars:

  roles:

    - role: nephelaiio.plugins
    - role: nephelaiio.pip
    - role: linux-system-roles.network
      when: ansible_default_ipv4.interface != 'br0'
    - role: ovirt.repositories
    - role: linux-system-roles.cockpit

  pre_tasks:

    - name: install cockpit
      package:
        name: cockpit
      tags:
        - cockpit

    - name: create cockpit firewall rule
      firewalld:
        service: cockpit
        permanent: yes
        state: enabled
      tags:
        - cockpit
        - firewall
      notify: restart firewalld

    - name: start cockpit
      service:
        name: cockpit
        state: started
        enabled: yes
      tags:
        - cockpit

    - meta: flush_handlers

  tasks:

    - name: install ovirt cockpit dashboard
      package:
        name: cockpit-ovirt-dashboard
      notify: restart cockpit

    - name: install ovirt engine appliance package
      package:
        name: ovirt-engine-appliance
      notify: restart cockpit

  handlers:

    - name: restart cockpit
      service:
        name: cockpit
        state: restarted
      tags:
        - cockpit

    - name: restart firewalld
      service:
        name: firewalld
        state: reloaded
      tags:
        - cockpit
        - firewalld
