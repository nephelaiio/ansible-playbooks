---
- name: Prepare ovirt engine os

  hosts: ovirt_engine

  become: yes

  serial: 1

  tasks:

    - name: install firewall
      yum:
        name: firewalld

    - name: enable firewall
      service:
        name: firewalld
        state: started
        enabled: yes
      tags:
        - firewall

    - name: manage selinux state
      selinux:
        policy: targeted
        state: permissive
      notify: reboot node

    - name: flush handlers
      meta: flush_handlers

  handlers:

    - name: reboot node
      reboot:



- name: Install ovirt engine

  hosts: ovirt_engine

  become: yes

  vars:

    ovirt_engine_setup_version: '4.3'

  roles:

    - nephelaiio.plugins
    - ovirt.repositories

  tasks:

    - name: update ovirt pdns record
      uri:
        url: "{{ pdns_url }}/api/v1/servers/localhost/zones/{{ ovirt_fqdn_zone }}"
        method: PATCH
        return_content: yes
        body_format: json
        body:
          rrsets:
            - name: "{{ ovirt_fqdn_host }}"
              type: A
              ttl: 3600
              changetype: REPLACE
              records:
                - content: "{{ ansible_default_ipv4.address }}"
                  disabled: no
                  comments: []
        headers:
          X-API-Key: "{{ pdns_api_key }}"
        status_code: 204
      vars:
        ovirt_fqdn_host: "{{ ovirt_url | urlsplit('hostname') | regex_replace('\\.$', '') }}."
        ovirt_fqdn_zone: "{{ ovirt_fqdn_host | split_with('.') | tail | join('.') }}"
      register: pdns_zones_query

    - name: disable firewalld
      service:
        name: firewalld
        state: stopped
        enabled: no

    - name: install ovirt engine
      include_role:
        name: ovirt.engine-setup

    - name: upgrade ovirt engine
      include_role:
        name: ovirt.engine-setup
      vars:
        ovirt_engine_setup_perform_upgrade: yes

    - name: install ovirt engine aaa extension
      package:
        name: ovirt-engine-extension-aaa-ldap-setup

    - name: disable ovirt-engine ssl validation
      lineinfile:
        path: /etc/ovirt-engine/engine.conf.d/11-setup-sso.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop_control:
        label: "{{ item.line }}"
      loop:
        - regexp: "^ENGINE_SSO_SERVICE_SSL_VERIFY_HOST="
          line: "ENGINE_SSO_SERVICE_SSL_VERIFY_HOST=false"
        - regexp: "^ENGINE_SSO_SERVICE_SSL_VERIFY_CHAIN="
          line: "ENGINE_SSO_SERVICE_SSL_VERIFY_CHAIN=false"
      notify: restart ovirt engine

  handlers:

    - name: restart ovirt engine
      service:
        name: ovirt-engine
        state: restarted
