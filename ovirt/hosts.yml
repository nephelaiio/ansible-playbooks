---
- name: Install ovirt hosts

  hosts: ovirt_hosts

  become: yes

  vars:
    ovirt_datastore_name: data
    ovirt_datastore_path: /mnt/gluster/data
    ovirt_pvs:
      - /dev/sda2
    ovirt_vgname: vg_ovirt
    ovirt_tpname: tp_ovirt
    ovirt_tpsize: '440G'
    ovirt_tpmdsize: '8G'
    gluster_owner_gid: '36'
    gluster_owner_uid: '36'
    gluster_infra_fw_enabled: no
    gluster_infra_disktype: JBOD
    gluster_infra_volume_groups:
      - vgname: "{{ ovirt_vgname }}"
        pvname: "{{ [ovirt_pvs] | flatten | join_with(',') }}"
    gluster_infra_thinpools:
      - vgname: "{{ ovirt_vgname }}"
        thinpoolname: "{{ ovirt_tpname }}"
        poolmetadatasize: "{{ ovirt_tpmdsize }}"
    gluster_infra_lv_logicalvols:
      - vgname: "{{ ovirt_vgname }}"
        thinpool: "{{ ovirt_tpname }}"
        lvname: "{{ ovirt_datastore_name }}"
        lvsize: "{{ ovirt_tpsize }}"
    gluster_infra_mount_devices:
      - path: "{ ovirt_datastore_path }}"
        vgname: "{{ ovirt_vgname }}"
        lvname: "{{ ovirt_datastore_name }}"
    fstrim_service:
      enabled: yes
      schedule:
        hour: "{{ range(1, 4) | random() }}"

  roles:

    - role: nephelaiio.plugins
    - role: nephelaiio.pip
    - role: linux-system-roles.network
      when: ansible_default_ipv4.interface != 'br0'
    - role: ovirt.repositories
    - role: gluster.infra

  pre_tasks:

    - name: disable firewall
      service:
        name: firewalld
        state: stopped
        enabled: false

    - name: create mount root
      file:
        path: /mnt/gluster
        state: directory

  tasks:

    - name: install gluster service
      package:
        name: glusterfs-server

    - name: create gluster data volume
      include_role:
        name: gluster_volume
      vars:
        gluster_cluster_bricks: "{{ ovirt_datastore_path }}"
        gluster_cluster_hosts: "{{ groups['ovirt_hosts'] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | list }}"
        gluster_replica_count: 3
        gluster_cluster_state: present
        gluster_cluster_volume: "{{ ovirt_datastore_name }}"
        gluster_cluster_options:
          storage.owner-gid: "{{ gluster_owner_gid }}"
          storage.owner-uid: "{{ gluster_owner_uid }}"
      run_once: yes

  post_tasks:

    - block: 

        - name: install yum requirements
          yum:
            name:
              - epel-release
              - "@Development tools"
              - python-devel
              - libxml2-devel

        - name: install pip requirements
          pip:
            name: ovirt-engine-sdk-python

        - name: register host
          include_role:
            name: ovirt.hosts
          vars:
            hosts:
              - name: "{{ ansible_fqdn }}"
                address: "{{ ansible_fqdn }}"
                cluster: "{{ ovirt_cluster }}"
                password: "{{ ovirt_user_pass }}"

      when: ovirt_register_host | default('no') | bool

    - name: create storage domain
      ovirt_storage_domain:
        name: "{{ ovirt_datastore_name }}"
        data_center: "{{ ovirt_data_center }}"
        glusterfs:
          address: "{{ ansible_fqdn }}"
          path: "/{{ ovirt_datastore_name }}"
        auth: "{{ ovirt_auth }}"
      run_once: yes

