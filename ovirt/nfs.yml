---
- name: Configure ovirt nfs storage

  hosts: ovirt_nfs

  become: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: create nfs firewall rules
      firewalld:
        service: "{{ item }}"
        permanent: yes
        state: enabled
      loop:
        - nfs
        - mountd
        - rpc-bind
      when: ansible_os_family | lower == 'redhat'
      notify: restart firewalld

    - name: create ovirt targets
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default(omit) }}"
        group: "{{ item.group | default(omit) }}"
        mode: "{{ item.mode | default(omit) }}"
      loop_control:
        label: "{{ item.path }}"
      loop: "{{ nfs_export_data }}"

    - name: build export entries
      set_fact:
        nfs_exports: "{{ (nfs_exports | default([])) + [item.path + ' ' + item.options] }}"
      loop_control:
        label: "{{ item.path }}"
      loop: "{{ nfs_export_data }}"

    - name: install and configure nfs
      include_role:
        name: nephelaiio.nfs

    - name: export filesystems
      command: exportfs -a
      changed_when: false

    - block:

        - name: install pip requirements
          pip:
            name: ovirt-engine-sdk-python

        - name: register storage domains
          ovirt_storage_domain:
            name: "{{ ansible_hostname }}-{{ item.1.path | regex_replace('^/', '') | regex_replace('/', '_') }}"
            host: "{{ item.0 }}"
            data_center: "{{ ovirt_data_center }}"
            auth: "{{ ovirt_auth }}"
            nfs:
              address: "{{ ansible_default_ipv4.address }}"
              path: "{{ item.1.path }}"
          loop_control:
            label: "{{ ansible_hostname }}-{{ item.1.path | regex_replace('$/', '') | regex_replace('/', '_') }}"
          loop: "{{ groups['ovirt_hosts'] | product(nfs_export_data) | list }}"

      delegate_to: localhost
