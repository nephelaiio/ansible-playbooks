---
- name: install pip requirements
  pip:
    name: python-consul

- name: "create consul service {{ consul_service_name }}"
  consul:
    state: "{{ consul_service_state }}"
    host: "{{ consul_service_client_address }}"
    service_name: "{{ consul_service_name }}"
    service_address: "{{ consul_service_address }}"
    service_port: "{{ consul_service_port }}"
    interval: "{{ consul_service_interval }}"
    timeout: "{{ consul_service_timeout }}"
    token: "{{ consul_service_token }}"
    tags: "{{ consul_service_tags | default(omit) }}"
  tags:
    - debug

- name: "create service pdns cname {{ consul_service_cname }}"
  uri:
    url: "{{ consul_service_pdns_url }}/api/v1/servers/localhost/zones/{{ consul_service_pdns_zone }}"
    method: PATCH
    body_format: json
    body:
      rrsets:
        - name: "{{ consul_service_pdns_host }}"
          type: CNAME
          ttl: 3600
          changetype: REPLACE
          records:
            - content: "{{ consul_service_cname }}"
              disabled: no
              set-ptr: no
              comments: []
    headers:
      X-API-Key: "{{ consul_service_pdns_api_key }}"
    status_code: 204
