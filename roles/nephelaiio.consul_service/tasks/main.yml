---
- name: create consul service {{ consul_service_name }}
  consul:
    scheme: "{{ consul_client_scheme }}"
    host: "{{ consul_client_address }}"
    port: "{{ consul_ports_http }}"
    service_name: "{{ consul_service_name }}"
    service_address: "{{ consul_service_address }}"
    service_port: "{{ consul_service_port }}"
    interval: "{{ consul_service_interval }}"
    timeout: "{{ consul_service_timeout }}"
    tags: "{{ consul_service_tags | default(omit) }}"

- name: create service pdns cname {{ consul_cname }}
  uri:
    url: "{{ traefik_pdns_url }}/api/v1/servers/localhost/zones/{{ pdns_zone }}"
    method: PATCH
    body_format: json
    body:
      rrsets:
        - name: "{{ pdns_host }}"
          type: CNAME
          ttl: 3600
          changetype: REPLACE
          records:
            - content: "{{ consul_cname }}"
              disabled: no
              set-ptr: no
              comments: []
    headers:
      X-API-Key: "{{ traefik_pdns_api_key }}"
    status_code: 204
  vars:
    pdns_zone: "{{ traefik_service_domain | regex_replace('\\.$', '.') }}."
    pdns_host: "{{ traefik_service_name }}.{{ pdns_zone }}"
    consul_zone: "{{ traefik_consul_domain | regex_replace('\\.$', '.') }}."
    consul_cname: "{{ traefik_service_name }}.service.{{ consul_zone }}"
