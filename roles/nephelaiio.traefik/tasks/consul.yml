---
- name: manage consul tls acls
  acl:
    path: "{{ item }}"
    entity: "{{ consul_user }}"
    etype: user
    permissions: r
    state: present
  loop:
    - "{{ consul_tls_ca_crt }}"
    - "{{ consul_tls_server_crt }}"
    - "{{ consul_server_key }}"

- name: install consul
  include_role:
    name: brianshumate.consul
  vars:
    consul_group_name: "{{ traefik_group_name }}"
    consul_node_role: server
    consul_bootstrap_expect: yes
    consul_dnsmasq_enable: yes
    consul_node_role: server
    consul_user: consul
    consul_install_upgrade: yes
    consul_autopilot_enable: yes
    consul_autopilot_cleanup_dead_servers: yes
    consul_tls_verify_incoming: yes
    consul_tls_verify_outgoing: yes
    consul_enable_local_script_checks: yes

- name: execute handlers
  meta: flush_handlers
