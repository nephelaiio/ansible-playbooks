---
- name: install traefik kv conf requirements
  pip:
    name: python-consul

- name: reset traefik kv
  consul_kv:
    scheme: http
    host: localhost
    port: "{{ consul_ports_http }}"
    key: "{{ traefik_prefix }}/"
    state: absent
    recurse: yes
  run_once: yes

- name: configure traefik kv
  consul_kv:
    scheme: http
    host: localhost
    port: "{{ consul_ports_http }}"
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ [traefik_config] | map('to_kv', '/', traefik_prefix) | list | flatten }}"
  run_once: yes
  no_log: traefik_nolog | default('yes') | bool

- name: install traefik
  include_role:
    name: kibatic.traefik
  vars:
    traefik_template: templates/config.toml
