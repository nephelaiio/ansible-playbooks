---
- name: install traefik kv conf requirements
  pip:
    name: python-consul

- name: gather service facts
  service_facts:

- name: disable systemd-resolved
  systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
    masked: yes
  when: "'systemd-resolved.service' in ansible_facts.services"

- block:

    - name: install trefik token requirements
      pip:
        name:
          - python-consul
          - pyhcl

    - name: create traefik consul token
      consul_acl:
        host: "{{ ansible_default_ipv4.address }}"
        token: "{{ traefik_consul_token }}"
        mgmt_token: "{{ consul_acl_master_token }}"
        name: traefik
        rules:
          - key: ""
            policy: write
          - session: ""
            policy: write
          - service: ""
            policy: read
          - node: ""
            policy: read
      when: traefik_consul_token is defined

  delegate_to: localhost
  run_once: yes

- name: reset traefik kv
  consul_kv:
    host: "{{ ansible_default_ipv4.address }}"
    key: "{{ traefik_prefix }}/"
    state: absent
    recurse: yes
    token: "{{ traefik_consul_token | default(omit) }}"
  run_once: yes

- name: configure traefik kv
  consul_kv:
    host: "{{ ansible_default_ipv4.address }}"
    key: "{{ item.key }}"
    value: "{{ item.value }}"
    token: "{{ traefik_consul_token | default(omit) }}"
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ [traefik_config] | map('to_kv', '/', traefik_prefix) | list | flatten }}"
  run_once: yes
  no_log: traefik_nolog | default('yes') | bool

- name: install traefik
  include_role:
    name: kibatic.traefik
  vars:
    traefik_template: templates/config.toml
    traefik_systemd_unit_template: templates/systemd.service
    traefik_binary_url: "https://github.com/containous/traefik/releases/download/v{{ traefik_release }}/traefik_linux-amd64"

- name: register traefik service
  include_role:
    name: nephelaiio.consul_service
  vars:
    consul_service_client_address: "{{ consul_client_address }}"
    consul_service_name: "{{ traefik_service_name }}"
    consul_service_port: "{{ traefik_dashboard_port }}"
    consul_service_tags:
      - "{{ traefik_prefix }}.enable=true"
  when:
    - traefik_service_domain is defined
