---
- name: install traefik kv conf requirements
  pip:
    name: python-consul

- name: reset traefik kv
  consul_kv:
    scheme: "{{ consul_client_scheme }}"
    host: "{{ consul_client_host }}"
    port: "{{ consul_ports_http }}"
    key: "{{ traefik_prefix }}/"
    state: absent
    recurse: yes
  run_once: yes

- name: configure traefik kv
  consul_kv:
    scheme: "{{ consul_client_scheme }}"
    host: "{{ consul_client_address }}"
    port: "{{ consul_ports_http }}"
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ [traefik_config] | map('to_kv', '/', traefik_prefix) | list | flatten }}"
  run_once: yes
  no_log: traefik_nolog | default('yes') | bool

- name: install traefik
  include_role:
    name: kibatic.traefik
  vars:
    traefik_template: templates/config.toml

- name: register traefik service
  include_role:
    name: nephelaiio.consul_service
  vars:
    consul_service_name: "{{ traefik_service_name }}"
    consul_service_port: "{{ traefik_dashboard_port }}"
    consul_pdns_url: "{{ traefik_pdns_url }}"
    consul_pdns_api_key: "{{ traefik_pdns_api_key }}"
    consul_service_tags:
      - "{{ traefik_prefix }}.enable=true"
  when:
    - traefik_service_domain is defined
