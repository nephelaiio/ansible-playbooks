---
- block:

  - name: set recursor metadata
    set_fact:
      pdns_recursor_domains: "{{ traefik_pdns_recursors | default([]) | product([traefik_service_domain | default('traefik')]) | list }}"

  - name: query resolver delegations
    uri:
      url: "https://{{ item }}/api/v1/servers/localhost/zones"
      method: GET
      headers:
        X-API-Key: "{{ pdns_rec_api_key }}"
      validate_certs: no
    loop: "{{ traefik_pdns_recursors | default([]) }}"
    register: pdns_recursor_zones

  - name: delete recursor delegations
    uri:
      url: "https://{{ recursor }}/api/v1/servers/localhost/zones/{{ zone_id }}"
      method: DELETE
      status_code:
        - 200
        - 204
      headers:
        X-API-Key: "{{ pdns_rec_api_key }}"
    loop_control:
      label: "{{ recursor }}: {{ zone_name }}"
    vars:
      recursor: "{{ item.0 }}"
      zone_name: "{{ item.1 }}"
      recursor_zones: "{{ pdns_recursor_zones.results | selectattr('item', 'equalto', recursor) | first }}"
      zone_id: "{{ (recursor_zones.json | selectattr('name', 'match', zone_name + '\\.?') | first).id | default('') }}"
    loop: "{{ pdns_recursor_domains }}"
    when: zone_id != ''

  - name: create recursor delegation
    uri:
      url: "https://{{ recursor }}/api/v1/servers/localhost/zones"
      method: POST
      status_code:
        - 200
        - 201
      body_format: json
      body:
        name: "{{ zone_name }}"
        type: Zone
        kind: Forwarded
        servers: "{{ groups[traefik_group_name] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | list }}"
        recursion_desired: yes
      headers:
        X-API-Key: "{{ pdns_rec_api_key }}"
    loop_control:
      label: "{{ recursor }}: {{ zone_name }}"
    vars:
      recursor: "{{ item.0 }}"
      zone_name: "{{ item.1 | regex_replace('\\.?$', '') }}."
    loop: "{{ pdns_recursor_domains }}"

  run_once: yes
