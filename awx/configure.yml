---
- name: Configure awx

  hosts: awx_app

  become: yes

  vars:

    awx_cli_conf: ~/.tower_cli.cfg
    awx_settings: {}
    awx_nolog: yes

  roles:

    - nephelaiio.plugins

  tasks:

    - name: include vars files
      include_vars:
        dir: "{{ item }}"
      loop: "{{ vars_dirs | list }}"
      ignore_errors: yes
      when: vars_dirs is defined

    - name: install tower cli
      pip:
        name: ansible-tower-cli
        state: present

    - name: create tower cli configuration file
      template:
        src: tower_cli.cfg.j2
        dest: "{{ awx_cli_conf }}"
        mode: 0600
      vars:
        host: "{{ awx_url | urlsplit('hostname') }}"
        username: "{{ awx_admin_user | default('admin') }}"
        password: "{{ awx_admin_pass }}"
        verify_ssl: false
        verbose: false

    - block:

        - name: manage awx settings
          tower_settings:
            name: "{{ item.key }}"
            value: "{{ item.value }}"
          loop_control:
            label: "{{ item.key }}"
          loop: "{{ awx_settings | dict2items }}"

        - name: destroy awx job schedules
          include_tasks: schedule_destroy.yml
          vars:
            schedule: "{{ item }}"
          loop_control:
            label: "{{ schedule.name }}"
          loop: "{{ awx_schedules }}"
          when: schedule.state | default('present') == 'absent'
          no_log: "{{ awx_nolog }}"

        - name: destroy awx workflows
          include_tasks: workflow_destroy.yml
          vars:
            organization: "{{ item.0 }}"
            workflow: "{{ item.1 }}"
          loop_control:
            label: "{{ workflow.name }}"
          loop: "{{ awx_organizations | subelements('workflows', skip_missing='yes') }}"
          when: organization.state | default('present') == 'absent' or workflow.state | default('present') == 'absent'
          no_log: "{{ awx_nolog }}"

        - name: destroy awx job templates
          include_tasks: template_destroy.yml
          vars:
            template: "{{ item }}"
          loop_control:
            label: "{{ template.name }}"
          loop: "{{ awx_templates }}"
          when: template.state | default('present') == 'absent'
          no_log: "{{ awx_nolog }}"

        - name: destroy awx inventories
          include_tasks: inventory_destroy.yml
          vars:
            organization: "{{ item.0 }}"
            inventory: "{{ item.1 }}"
          loop_control:
            label: "{{ inventory.name }}"
          loop: "{{ awx_organizations | subelements('inventories', skip_missing='yes') }}"
          when: organization.state | default('present') == 'absent' or inventory.state | default('present') == 'absent'
          no_log: "{{ awx_nolog }}"

        - name: destroy awx projects
          include_tasks: project_destroy.yml
          vars:
            organization: "{{ item.0 }}"
            project: "{{ item.1 }}"
          loop_control:
            label: "{{ project.name }}"
          loop: "{{ awx_organizations | subelements('projects', skip_missing='yes') }}"
          when: organization.state | default('present') == 'absent' or project.state | default('present') == 'absent'
          no_log: "{{ awx_nolog }}"

        - name: destroy awx credentials
          include_tasks: credential_destroy.yml
          vars:
            organization: "{{ item.0 }}"
            credential: "{{ item.1 }}"
          loop_control:
            label: "{{ credential.name }}"
          loop: "{{ awx_organizations | subelements('credentials', skip_missing='yes') }}"
          when: organization.state | default('present') == 'absent' or credential.state | default('present') == 'absent'
          no_log: "{{ awx_nolog }}"

        - name: destroy awx organizations
          tower_organization:
            name: "{{ organization.name }}"
            state: absent
          vars:
            organization: "{{ item }}"
          loop: "{{ awx_organizations | list }}"
          when: organization.state | default('present') == 'absent'
          no_log: "{{ awx_nolog }}"

        - name: create awx organizations
          tower_organization:
            name: "{{ organization.name }}"
            state: present
          vars:
            organization: "{{ item }}"
          loop: "{{ awx_organizations | list }}"
          when: item.state | default('present') == 'present'
          no_log: "{{ awx_nolog }}"

        - name: create awx credentials
          include_tasks: credential_create.yml
          vars:
            organization: "{{ item.0 }}"
            credential: "{{ item.1 }}"
          loop_control:
            label: "{{ credential.name }}"
          loop: "{{ awx_organizations | subelements('credentials', skip_missing='yes') }}"
          when: organization.state | default('present') == 'present' or credential.state | default('present') == 'present'
          no_log: false

        - name: create awx projects
          include_tasks: project_create.yml
          vars:
            organization: "{{ item.0 }}"
            project: "{{ item.1 }}"
          loop_control:
            label: "{{ project.name }}"
          loop: "{{ awx_organizations | subelements('projects', skip_missing='yes') }}"
          when: organization.state | default('present') == 'present' and project.state | default('present') == 'present'
          no_log: "{{ awx_nolog }}"

        - name: create awx inventories
          include_tasks: inventory_create.yml
          vars:
            organization: "{{ item.0 }}"
            inventory: "{{ item.1 }}"
          loop_control:
            label: "{{ inventory.name }}"
          loop: "{{ awx_organizations | subelements('inventories', skip_missing='yes') }}"
          when: organization.state | default('present') == 'present' and inventory.state | default('present') == 'present'
          no_log: "{{ awx_nolog }}"

        - name: create awx job templates
          include_tasks: template_create.yml
          vars:
            template: "{{ item }}"
          loop_control:
            label: "{{ template.name }}"
          loop: "{{ awx_templates }}"
          when: template.state | default('present') == 'present'
          no_log: "{{ awx_nolog }}"

        - name: create awx workflows
          include_tasks: workflow_create.yml
          vars:
            organization: "{{ item.0 }}"
            workflow: "{{ item.1 }}"
          loop_control:
            label: "{{ workflow.name }}"
          loop: "{{ awx_organizations | subelements('workflows', skip_missing='yes') }}"
          when: organization.state | default('present') == 'present' and workflow.state | default('present') == 'present'
          no_log: "{{ awx_nolog }}"

        - name: create awx job schedules
          include_tasks: schedule_create.yml
          vars:
            schedule: "{{ item }}"
          loop_control:
            label: "{{ schedule.name }}"
          loop: "{{ awx_schedules }}"
          when: schedule.state | default('present') == 'present'
          no_log: "{{ awx_nolog }}"

      run_once: yes
