---
- name: Install awx

  hosts: awx

  become: yes

  vars:

    docker_pip_helpers:
      - docker
      - docker-compose

    acme_certificate_domain: "{{ awx_url | urlsplit('hostname') }}"
    acme_certificate_chainfile: "/etc/nginx/{{ acme_certificate_domain }}.chain.crt"
    acme_certificate_keyfile: "/etc/nginx/{{ acme_certificate_domain }}.key"
    acme_certificate_add_ca: yes
    acme_certificate_aws_accesskey_id: "{{ aws_access_key_id }}"
    acme_certificate_aws_accesskey_secret: "{{ aws_secret_access_key }}"

    nginx_install_from: os_repository
    nginx_cleanup_config_path:
      - /etc/nginx/conf.d
      - /etc/nginx/sites-enabled/default
      - /etc/nginx/sites-available/default
    nginx_main_template:
      conf_file_name: nginx.conf
      conf_file_location: /etc/nginx/
      user: www-data
      worker_processes: auto
      error_level: warn
      worker_connections: 1024
      http_enable: true
      http_settings:
        keepalive_timeout: 60
        cache: false
        rate_limit: false
        keyval: false
      stream_enable: false
      http_global_autoindex: false
      server_tokens: off
    nginx_http_template:
      awx:
        port: 443
        server_name: "{{ acme_certificate_domain }}"
        conf_file_name: "{{ acme_certificate_domain }}.https.conf"
        ssl:
          key: "{{ acme_certificate_keyfile }}"
          cert: "{{ acme_certificate_chainfile }}"
          protocols: TLSv1.2
          ciphers: HIGH:!aNULL:!MD5
        reverse_proxy:
          locations:
            default:
              location: /
              proxy_pass: http://awx
        upstreams:
          awx:
            name: awx
            lb_method: least_conn
            zone_name: awx
            zone_size: 32k
            sticky_cookie: false
            servers:
              localhost:
                address: localhost
                port: "{{ awx_container_port }}"
                weight: 1
                health_check: max_fails=3 fail_timeout=5s

    awx_container_port: 80
    host_port: "{{ awx_container_port }}"
    dockerhub_version: "{{ awx_release }}"
    dockerhub_base: ansible
    docker_compose_dir: /tmp/awxcompose
    awx_web_hostname: awxweb
    awx_task_hostname: awx
    pg_username: "{{ awx_pg_user | default('awx') }}"
    pg_password: "{{ awx_pg_pass }}"
    pg_database: "awx_{{ awx_release | regex_replace('\\.', '_') }}"
    pg_port: 5432
    postgres_data_dir: /opt/awx/data
    admin_user: "{{ awx_admin_user | default('admin') }}"
    admin_password: "{{ awx_admin_pass }}"
    secret_key: "{{ awx_key }}"
    create_preload_data: no
    rabbitmq_user: "{{ awx_rabbitmq_user | default('awx') }}"
    rabbitmq_password: "{{ awx_rabbitmq_password }}"
    rabbitmq_erlang_cookie: "{{ awx_rabbitmq_erlangcookie | default('hotfudgepecans') }}"

  roles:

    - nephelaiio.plugins
    - nephelaiio.pip
    - nephelaiio.docker
    - local_docker

  tasks:

    - name: install nginx
      import_role:
        name: nginxinc.nginx
      vars:
        nginx_cleanup_config: no
        nginx_http_template_enable: no
        nginx_main_template_enable: no

    - name: generate certificates
      import_role:
        name: nephelaiio.acme_certificate_route53

    - name: configure nginx
      import_role:
        name: nginxinc.nginx
      vars:
        nginx_cleanup_config: yes
        nginx_http_template_enable: yes
        nginx_main_template_enable: yes

    - name: update nginx pdns record
      uri:
        url: "{{ pdns_url }}/api/v1/servers/localhost/zones/{{ pdns_url_zone }}"
        method: PATCH
        return_content: yes
        body_format: json
        body:
          rrsets:
            - name: "{{ pdns_url_host }}"
              type: A
              ttl: 3600
              changetype: REPLACE
              records:
                - content: "{{ ansible_default_ipv4.address }}"
                  disabled: no
                  set-ptr: no
                  comments: []
        headers:
          X-API-Key: "{{ pdns_api_key }}"
        status_code: 204
      vars:
        pdns_url_host: "{{ acme_certificate_domain }}."
        pdns_url_zone: "{{ pdns_url_host | split_with('.') | tail | join('.') }}"
      register: pdns_zones_query
