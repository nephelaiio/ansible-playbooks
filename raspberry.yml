---
- import_playbook: raspbian.yml

- import_playbook: redhat.yml

- name: Configure raspbian

  hosts: raspberry

  become: yes

  tasks:

    - name: Disable ipv6
      sysctl:
        name: "{{ item }}"
        state: present
        value: 1
      with_items:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6
      register: disable_ipv6

    - name: Configure ntp
      include_role:
        name: geerlingguy.ntp
      vars:
        ntp_timezone: "{{ timezone }}"
        ntp_manage_config: true

    - name: Install rpi-update
      apt:
        name: rpi-update
        state: latest
        update_cache: yes

    - name: Upgrade firmware
      shell: rpi-update
      changed_when: false

    - name: Fix rsyslog
      copy:
        dest: /etc/rsyslog.conf
        src: raspberry/rsyslog.conf
      register: configure_rsyslog

    - name: Restart rsyslog
      when: configure_rsyslog.changed
      service:
        name: rsyslog
        state: restarted
