---
- name: Configure raspbian

  hosts: raspberry

  tasks:

    - name: Disable ipv6
      become: yes
      sysctl:
        name: "{{ item }}"
        state: present
        value: 1
      with_items:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6
      register: disable_ipv6

    - name: Configure ntp
      include_role:
        name: geerlingguy.ntp
      vars:
        ntp_timezone: "{{ timezone }}"
        ntp_manage_config: true

    - name: Install rpi-update
      become: yes
      apt:
        name: rpi-update
        state: latest
        update_cache: yes

    - name: Upgrade firmware
      become: yes
      shell: rpi-update
      changed_when: false

    - name: Fix rsyslog
      become: yes
      copy:
        dest: /etc/rsyslog.conf
        src: raspberry/rsyslog.conf
      register: configure_rsyslog

    - name: Restart rsyslog
      become: yes
      when: configure_rsyslog.changed
      service:
        name: rsyslog
        state: restarted

    - name: Configure remote logging
      include_role:
        name: alekseyp.papertrail
      vars:
        papertrail_destination: "{{ papertrail.destination }}"

    - name: Install fail2ban
      become: yes
      apt:
        name: fail2ban
        state: latest
        update_cache: yes

    - name: Configure fail2ban networks
      become: yes
      lineinfile:
        regexp: '^ignoreip ='
        line: "ignoreip = 127.0.0.1/8, {{ network | ipaddr('net') }}"
        dest: /etc/fail2ban/jail.conf
        insertafter: '[DEFAULT]'
      vars:
        network: "{{ nets.home.network }}/{{ nets.home.netmask }}"
      register: configure_fail2ban

    - name: Restart fail2ban
      become: yes
      when: configure_fail2ban.changed
      service:
        name: fail2ban
        state: restarted

    - name: Manage fail2ban services
      become: yes
      service:
        name: fail2ban
        state: started
        enabled: yes

    - name: Disable ssh password logins
      become: yes
      lineinfile:
        regexp: '^#?PasswordAuthentication'
        line: "PasswordAuthentication no"
        dest: /etc/ssh/sshd_config
      register: configure_ssh

    - name: Restart ssh
      become: yes
      when: configure_ssh.changed
      service:
        name: ssh
        state: restarted
